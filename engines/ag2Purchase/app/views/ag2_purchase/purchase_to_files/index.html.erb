<script>
  $(document).ready(function() {
    $('.date_picker').datepicker({
      format : 'dd/mm/yyyy',
      weekStart : 1
    }).on('changeDate', function(e){
      $('.date_picker').datepicker('hide');
    });
    $('.sel2').select2({
      formatNoMatches: function(m) { return '<%= I18n.t("select2.no_matches") %>'; },
      containerCssClass: 'left-winged',
      allowClear: true
    });

    // Set default dates
    if ($('#From').val() == "") {
      $('#From').datepicker('setValue', es_date(new Date()));
    }
    if ($('#To').val() == "") {
      $('#To').datepicker('setValue', es_date(new Date()));
    }

    //$("#progressbar").css("width", "0%");
    $("#message_area").children().hide();
  });

  jQuery(function($) {
    // when #data_export_btn is clicked
    $("#data_export_btn").click(function() {
      // Choose method to execute based on selected type
      var method = 'export_suppliers';
      var type = $('#Export :selected').index();
      if (type == "") type = 0;
      if (type == 1) {
        method = 'export_supplier_invoices';
      }
      // Parameters
      var biller = $('#Biller :selected').val();
      var from = $('#From').val();
      var to = $('#To').val();
      if ((biller == "") || (from == "") || (to == ""))
        return;
      // make a POST call and executes action
      $('#message_area').children().show();
      $('#buttons').children().hide();
      jQuery.getJSON(method + "?company=" + biller + "&from=" + from + "&to=" + to, function(data) {
        $(".modal-body > p").html(data.DataExport);
        $("#exportinfo").modal("show");
        if (data.Result == 'OK') {
          // $("#message").html('<%#= link_to I18n.t("ag2_purchase.purchase_to_files.index.go_to_target"), "#{@bl_file}" %>');
          $("#message").html('<%= link_to I18n.t("ag2_purchase.purchase_to_files.index.go_to_target"), "#{@bl_file}" %>');
          // $('#message_area').children().hide();
          $("#progressbar").hide();
        }
        else {
          $('#message_area').children().hide();
        }
        $('#buttons').children().show();
      })
      return false;
    });
  })
</script>

<%= render '/layouts/ag2_purchase/purchasetofilebreadcrumb' %>
<%= render '/layouts/exportinfo' %>

<div class="row">
  <div class="span12">
    <h3 class="import-h3"><%= t(".title") %></h3>
  </div>
</div>
<div class="row-fluid">
  <div class="span7">
    <div class="import-description">
      <h4><%=t '.task' %></h4>
      <br />
      <p>
        <%=t '.description' %>
        <%=t '.description_html' %>
      </p>
      <p class="track-caution">
        <%= t '.dates_caution' %>
      </p>
      <p class="bolded">
        <%=t '.do_not_interrupt' %>
      </p>
    </div>
  </div>
  <div class="span5 import-box">
    <div align="center">
      <p class="import-caution">
        <%=t '.caution' %>
      </p>
      <%= form_tag "ag2_purchase_track", :method => 'get' do %>
      <!-- Export -->
      <%= label_tag "label_export", t(".label_export"), :class => 'form-label' %>
      <%= select_tag "Export", options_for_select(@export, 0), :class => 'x-large-text-field' %>
      <!-- Company -->
      <%= label_tag "label_biller", t(".label_biller"), :class => 'form-label' %>
      <%= select_tag "Biller", options_from_collection_for_select(@billers, "id", "name"), :prompt => "", :class => 'x-large-text-field sel2' %>
      <!-- Dates -->
      <%= label_tag "label_from", t(".label_from"), :class => 'form-label-under-sel2' %>
      <%= text_field_tag "From", params[:from], :class =>  'mid-text-field date_picker centered' %>
      <%= label_tag "label_to", t(".label_to"), :class => 'form-label' %>
      <%= text_field_tag "To", params[:to], :class =>  'mid-text-field date_picker centered' %>
      <!-- Buttons -->
      <div id="buttons">
        <p>
          <%=t '.are_you_sure' %>
        </p>
        <p>
          <a href="#" id="data_export_btn" class="btn btn-primary"><%=t '.btn_yes' %></a>
          <a href="<%= ag2_gest.bill_management_path %>" id="exit_btn" class="btn btn-primary"><%=t '.btn_no' %></a>
          <!--<a href="#" id="report_btn" class="btn btn-primary form-button-under-sel2"><%#= t '.report_btn' %></a>-->
        </p>
      </div>
      <% end %>
      <br />
      <div id="message_area">
        <span id="message"><%=t '.message' %></span>
        <div id="progressbar" class="bert2-green-progress"></div>
      </div>
    </div>
  </div>
</div>
