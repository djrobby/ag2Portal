// Current localization
_currentLocale = '<%= I18n.locale %>'
if (_currentLocale == 'es') {
  _delimiter = '.';
  _separator = ',';
} else {
  _delimiter = ',';
  _separator = '.';
}

$('#pendings').html("<%= escape_javascript(render('bills_pendings')) %>");
$('#pendings').addClass('pendings');
// $('#unpaid').html("<%#= escape_javascript(render('bills_unpaid')) %>");
$('#charged').html("<%= escape_javascript(render('bills_charged')) %>");
$('#cash').html("<%= escape_javascript(render('payments_cash')) %>");
$('#banks').html("<%= escape_javascript(render('payments_bank')) %>");
$('#others').html("<%= escape_javascript(render('payments_other')) %>");
$('#fractionated').html("<%= escape_javascript(render('instalments')) %>");
if (_active_tab == "pendings-tab") {
  <% if !@bills_pending.blank? %>
  $("#cashier").show();
  _cashier_shown = true;
  <% end %>
} else if (_active_tab == "fractionated-tab") {
  <% if !@instalment_invoices.blank? %>
  $("#cashier").show();
  _cashier_shown = true;
  <% end %>
}

$('#payments-tabs a').click(function (e) {
  _active_tab = $(this).attr("id");
  total_debt = 0;
  e.preventDefault();
  $('input:checkbox').removeAttr('checked');
  $(".debt-total-cashier").text(total_debt.format(2, 3, _delimiter, _separator));    
  $(".cash-return-cashier").text(total_debt.format(2, 3, _delimiter, _separator));    
  $(this).tab('show');
  if (_active_tab == "pendings-tab") {
    <% if !@bills_pending.blank? %>
    $("#cashier").show();
    _cashier_shown = true;
    <% else %>
    $("#cashier").hide();
    _cashier_shown = false;
    <% end %>
  } else if (_active_tab == "fractionated-tab") {
    <% if !@instalment_invoices.blank? %>
    $("#cashier").show();
    _cashier_shown = true;
    <% else %>
    $("#cashier").hide();
    _cashier_shown = false;
    <% end %>
  } else {
    $("#cashier").hide();
  _cashier_shown = false;
  }
});

$('.accor').click(function () {
  if (this.classList.contains("collapsed")){
    this.children[0].className = "icon-minus";
  }else {
    this.children[0].className = "icon-plus";
  }
});

$(".btn-payment").click(function(){
  var elements = $( "input:checked" );
  // if (elements.length <= 0) return false;
  var invoices_id = [];
  var debts_array = [];
  for(var i=0;typeof(elements[i])!='undefined';invoices_id.push(elements[i++].getAttribute('value')));
  for(var i=0;typeof(elements[i])!='undefined';debts_array.push(elements[i++].getAttribute('data-debt')));
  var total_debt = 0.0;
  for (var i = 0; i < debts_array.length; i++) {
    if(debts_array[i] != null){
      total_debt += parseFloat(debts_array[i]);
    }
  }
  $(".debt-total").text(total_debt.format(2, 3, _delimiter, _separator));

  // Update Ids in the
  $("#client_payment_invoices_ids").val(invoices_id.filter(i=>i!=null))         // cash
  $("#client_payment_other_invoices_ids").val(invoices_id.filter(i=>i!=null))   // others
  $("#client_payment_bank_invoices_ids").val(invoices_id.filter(i=>i!=null))    // bank
  $("#instalment_invoices_ids").val(invoices_id.filter(i=>i!=null))             // instalments
});

$("#close-cash").click(function(){
  var cp_ids = [];
  var cp_amount = 0;
  $('#cash-table tr').each(function() {
    id = $(this).find('td.cp-id').text();
    if (id != null && id != '') cp_ids.push(id);
    // amount = $(this).find('td.cp-amount').val();
    // cp_amount += parseFloat(amount);
  });  
  $("#close_cash_client_payments_ids").val(cp_ids.filter(i => i!=null || i!=''))   // modal-cash
  // $("#close_cash_total-cash").text(cp_amount.format(4, 3, _delimiter, _separator));
});

$("#cash-to-pending").click(function(){
  var cp_ids = [];
  $('#cash-table tr').each(function() {
    id = $(this).find('td.cp-id').text();
    if (id != null && id != '') cp_ids.push(id);
  });  
  $("#cash_to_pending_client_payments_ids").val(cp_ids.filter(i => i!=null || i!=''))   // modal-cash-to-pending
});

$("#bank-confirm").click(function(){
  var cp_ids = [];
  var cp_amount = 0.0;
  $('#bank-table tr').each(function() {
    if ($(this).find('td input:checkbox').is(':checked')) {
      id = $(this).find('td.cpb-id').text();
      if (id != null && id != '') {
        cp_ids.push(id);
        amount = $(this).find('td.cpb-amount').text().replace(",", ".");
        cp_amount += parseFloat(amount);
      }
    }
  });
  if (cp_ids.length <= 0) {
    alert('¡Debes seleccionar cobros pendientes de confirmar!');
    return false;
  } else {
    $("#bank_confirm_client_payments_ids").val(cp_ids)   // modal-bank
    $("#bank-bills-selected").html(cp_ids.length);
    $("#bank-total-selected").html(cp_amount.format(4, 3, _delimiter, _separator));
  }
});

$("#bank-to-pending").click(function(){
  var cp_ids = [];
  var cp_amount = 0.0;
  $('#bank-table tr').each(function() {
    if ($(this).find('td input:checkbox').is(':checked')) {
      id = $(this).find('td.cpb-id').text();
      if (id != null && id != '') {
        cp_ids.push(id);
        amount = $(this).find('td.cpb-amount').text().replace(",", ".");
        cp_amount += parseFloat(amount);
      }
    }
  });
  if (cp_ids.length <= 0) {
    alert('¡Debes seleccionar cobros pendientes de confirmar!');
    return false;
  } else {
    $("#bank_to_pending_client_payments_ids").val(cp_ids.filter(i => i!=null || i!=''))   // modal-bank-to-pending
    $("#bank-to-pending-bills-selected").html(cp_ids.length);
    $("#bank-to-pending-total-selected").html(cp_amount.format(4, 3, _delimiter, _separator));
  }
});

$(".btn-cash").click(function (e) {
  ids = $("#client_payment_invoices_ids").val();
  if (ids == null || ids == '') {
    alert('¡Debes seleccionar recibos o facturas pendientes de cobrar!');
    return false;
  }
  $("#client_payment_amount").val(0);
  $("#client_payment_payment_method_id").select2("val", 0);
});

$(".btn-bank").click(function (e) {
  ids = $("#client_payment_bank_invoices_ids").val();
  if (ids == null || ids == '') {
    alert('¡Debes seleccionar recibos o facturas pendientes de cobrar!');
    return false;
  }
  $("#client_payment_bank_receipt_no").val("");
});

$(".btn-fractionated").click(function (e) {
  ids = $("#instalment_invoices_ids").val();
  if (ids == null || ids == '') {
    alert('¡Debes seleccionar recibos o facturas pendientes de cobrar!');
    return false;
  }
  $("#instalment_number_inst").val(1);
  $("#instalment_amount_first").val(0);
  $("#instalment_charge").val(0);
  $("#instalment_payment_method_id").select2("val", 0);
});

$(".btn-others").click(function (e) {
  ids = $("#client_payment_other_invoices_ids").val();
  if (ids == null || ids == '') {
    alert('¡Debes seleccionar recibos o facturas pendientes de cobrar!');
    return false;
  }
  $("#client_payment_other_amount").val(0);
  $("#client_payment_other_payment_method_id").select2("val", 0);
});

$(".btn-bank-instalment").click(function (e) {
  ids = $("#client_payment_bank_invoices_ids").val();
  if (ids == null || ids == '') {
    alert('¡Debes seleccionar plazos pendientes de cobrar!');
    return false;
  }
  $("#client_payment_bank_receipt_no").val("");
});

/* modal_cash form.client_payment: Check required values before submit */
$("form.cash-form").submit(function(){
  if ($('#client_payment_amount').val() == '' ||
      $('#client_payment_amount').val() == null) {
    alert("<%= I18n.t('activerecord.attributes.client_payment.amount') %> <%= I18n.t(:item_error) %>");
    return false;
  }
  if ($('#client_payment_payment_method_id').val() == '' ||
      $('#client_payment_payment_method_id').val() == null) {
    alert("<%= I18n.t('activerecord.attributes.client_payment.payment_method_id') %> <%= I18n.t(:item_error) %>");
    return false;
  }
});
// $("#btn-submit-modal-cash").click(function(){
//   alert('js');
//   if ($('#client_payment_amount').val() == '' ||
//       $('#client_payment_amount').val() == null) {
//     alert("<%= I18n.t('activerecord.attributes.client_payment.amount') %> <%= I18n.t(:item_error) %>");
//     return false;
//   }
//   if ($('#client_payment_payment_method_id').val() == '' ||
//       $('#client_payment_payment_method_id').val() == null) {
//     alert("<%= I18n.t('activerecord.attributes.client_payment.payment_method_id') %> <%= I18n.t(:item_error) %>");
//     return false;
//   }
// });

/* modal_others form.client_payment_other: Check required values before submit */
$("form.others-form").submit(function(){
  if ($('#client_payment_other_amount').val() == '' ||
      $('#client_payment_other_amount').val() == null) {
    alert("<%= I18n.t('activerecord.attributes.client_payment.amount') %> <%= I18n.t(:item_error) %>");
    return false;
  }
  if ($('#client_payment_other_payment_method_id').val() == '' ||
      $('#client_payment_other_payment_method_id').val() == null) {
    alert("<%= I18n.t('activerecord.attributes.client_payment.payment_method_id') %> <%= I18n.t(:item_error) %>");
    return false;
  }
});
// $("#btn-submit-modal-others").click(function(){
//   if ($('#client_payment_amount').val() == '' ||
//       $('#client_payment_amount').val() == null) {
//     alert("<%= I18n.t('activerecord.attributes.client_payment.amount') %> <%= I18n.t(:item_error) %>");
//     return false;
//   }
//   if ($('#client_payment_payment_method_id').val() == '' ||
//       $('#client_payment_payment_method_id').val() == null) {
//     alert("<%= I18n.t('activerecord.attributes.client_payment.payment_method_id') %> <%= I18n.t(:item_error) %>");
//     return false;
//   }
// });

/* modal_bank form.client_payment_bank: Check required values before submit */
$("form.bank-form").submit(function(){
  if ($('#client_payment_bank_receipt_no').val() == '' ||
      $('#client_payment_bank_receipt_no').val() == null) {
    alert("<%= I18n.t('activerecord.attributes.client_payment.bank_order_no') %> <%= I18n.t(:item_error) %>");
    return false;
  }
});
// $("#btn-submit-modal-bank").click(function(){
//   if ($('#client_payment_bank_receipt_no').val() == '' ||
//       $('#client_payment_bank_receipt_no').val() == null) {
//     alert("<%= I18n.t('activerecord.attributes.client_payment.bank_order_no') %> <%= I18n.t(:item_error) %>");
//     return false;
//   }
// });

/* modal_instalment form.instalment: Check required values before submit */
$("form.instalment-form").submit(function(){
  if ($('#instalment_number_inst').val() == '' ||
      $('#instalment_number_inst').val() == null) {
    alert("<%= I18n.t('activerecord.attributes.instalment_plan.instalments_qty') %> <%= I18n.t(:item_error) %>");
    return false;
  }
  if ($('#instalment_amount_first').val() == '' ||
      $('#instalment_amount_first').val() == null) {
    alert("<%= I18n.t('activerecord.attributes.instalment_plan.amount_first') %> <%= I18n.t(:item_error) %>");
    return false;
  }
  if ($('#instalment_charge').val() == '' ||
      $('#instalment_charge').val() == null) {
    alert("<%= I18n.t('activerecord.attributes.instalment_plan.surcharge_pct') %> <%= I18n.t(:item_error) %>");
    return false;
  }
  if ($('#instalment_payment_method_id').val() == '' ||
      $('#instalment_payment_method_id').val() == null) {
    alert("<%= I18n.t('activerecord.attributes.instalment_plan.payment_method_id') %> <%= I18n.t(:item_error) %>");
    return false;
  }
});
// $("#btn-submit-modal-fracionated").click(function(){
//   if ($('#instalment_number_inst').val() == '' ||
//       $('#instalment_number_inst').val() == null) {
//     alert("<%= I18n.t('activerecord.attributes.instalment_plan.instalments_qty') %> <%= I18n.t(:item_error) %>");
//     return false;
//   }
//   if ($('#instalment_amount_first').val() == '' ||
//       $('#instalment_amount_first').val() == null) {
//     alert("<%= I18n.t('activerecord.attributes.instalment_plan.amount_first') %> <%= I18n.t(:item_error) %>");
//     return false;
//   }
//   if ($('#instalment_charge').val() == '' ||
//       $('#instalment_charge').val() == null) {
//     alert("<%= I18n.t('activerecord.attributes.instalment_plan.surcharge_pct') %> <%= I18n.t(:item_error) %>");
//     return false;
//   }
//   if ($('#instalment_payment_method_id').val() == '' ||
//       $('#instalment_payment_method_id').val() == null) {
//     alert("<%= I18n.t('activerecord.attributes.instalment_plan.payment_method_id') %> <%= I18n.t(:item_error) %>");
//     return false;
//   }
// });

/***
/* Manage checkboxes
***/

// Item checkbox at pending & bank
$(".checkbox-slave").click(function () {
  if (_cashier_shown) {
    var p = $(this).prop('checked');
    var total_debt = parseFloat(right_number($(".debt-total-cashier").text(), 2));
    var debt = parseFloat($(this).attr('data-debt'));
    if (p) {
      // Sum at cashier
      total_debt += debt
    } else {
      // Subtract at cashier
      total_debt -= debt
    }
    total_debt = Math.round(total_debt * 100) / 100
    $(".debt-total-cashier").text(total_debt.format(2, 3, _delimiter, _separator));
  }
});

// Table checkbox at pending: Updates slave
$(".checkbox-master").click(function () {
  $(this).parents(".accordion").find("tbody").find("input[type=checkbox]:not(:disabled)").prop('checked', $(this).prop('checked'));

  // Totalize and assign to cashier
  if (_cashier_shown) {
    var p = $(this).prop('checked');
    var total_debt = parseFloat(right_number($(".debt-total-cashier").text(), 2));
    var debt = 0;
    $(this).parents(".accordion").find(".pending-invoices-table").find("tr.fields").each(function() {
      if ($(this).find('.checkbox-slave').is(':enabled')) {
        debt += parseFloat(right_number($(this).find('.debt-field').text(), 4));
      }
    });
    if (p) {
      // Sum at cashier
      total_debt += debt
    } else {
      // Subtract at cashier
      total_debt -= debt
    }
    total_debt = Math.round(total_debt * 100) / 100
    $(".debt-total-cashier").text(total_debt.format(2, 3, _delimiter, _separator));
  }
});

// Global checkbox at pending: Updates master & slave
$(".checkbox-main").click(function () {
  $(".checkbox-slave:not(:disabled), .checkbox-master:not(:disabled)").prop('checked', $(this).prop('checked'));

  // Totalize and assign to cashier
  if (_cashier_shown) {
    var p = $(this).prop('checked');
    var total_debt = parseFloat(right_number($(".debt-total-cashier").text(), 2));
    var debt = 0;
    $(this).parents(".pendings").find(".accordion").find(".pending-invoices-table").find("tr.fields").each(function() {
      if ($(this).find('.checkbox-slave').is(':enabled')) {
        debt += parseFloat(right_number($(this).find('.debt-field').text(), 4));
      }
    });
    if (p) {
      // Sum at cashier
      total_debt += debt
    } else {
      // Subtract at cashier
      total_debt -= debt
    }
    total_debt = Math.round(total_debt * 100) / 100
    $(".debt-total-cashier").text(total_debt.format(2, 3, _delimiter, _separator));
  }
});

// Table checkbox at bank
$(".checkbox-master-table").click(function () {
  $(this).parents(".table").find("tbody").find("input[type=checkbox]").prop('checked', $(this).prop('checked'));
});

// Item checkbox at instalment
$(".instalment-checkbox-slave").click(function () {
  if (_cashier_shown) {
    var p = $(this).prop('checked');
    var total_debt = parseFloat(right_number($(".debt-total-cashier").text(), 2));
    var debt = parseFloat($(this).attr('data-debt'));
    if (p) {
      // Sum at cashier
      total_debt += debt
    } else {
      // Subtract at cashier
      total_debt -= debt
    }
    total_debt = Math.round(total_debt * 100) / 100
    $(".debt-total-cashier").text(total_debt.format(2, 3, _delimiter, _separator));
  }
});

// Table checkbox at instalment: Updates slave
$("#instalments-checkbox-master").click(function () {
  $(".instalment-checkbox-slave").prop('checked', $(this).prop('checked'));

  // Totalize and assign to cashier
  if (_cashier_shown) {
    var p = $(this).prop('checked');
    var total_debt = parseFloat(right_number($(".debt-total-cashier").text(), 2));
    var debt = 0;
    $(this).parents("#fractionated").find(".accordion").find("#instalments-table").find("tr.fields").each(function() {
      debt += parseFloat(right_number($(this).find('.debt-field').text(), 4));
    });
    if (p) {
      // Sum at cashier
      total_debt += debt
    } else {
      // Subtract at cashier
      total_debt -= debt
    }
    total_debt = Math.round(total_debt * 100) / 100
    $(".debt-total-cashier").text(total_debt.format(2, 3, _delimiter, _separator));
  }
});

/*** End manage checkboxes ***/

$("#client_payment_amount").change(function() {
  amount = parseFloat(this.value) || 0;
  debt = parseFloat($(this).parents(".modal").find(".debt-total").text().replace(",", ".")) || 0;
  cash_return = debt - amount;
  $(".cash-return").text(cash_return.format(2, 3, _delimiter, _separator));
});

$("#initial-cash").change(function() {
  initial_cash = parseFloat(this.value)
  cashed = parseFloat($("#total-cash").text());
  ending_cash = initial_cash + cashed
  $("#ending-cash").text(ending_cash.format(2, 3, _delimiter, _separator));
});

$("form.bank_confirm").submit(function(){
 var $input = $(this).find("input[name='bank_confirm[ids]']");
 var elements = $( "input.checkbox-slave:checked" );
 var client_payment_ids = [];
 for(var i=0;typeof(elements[i])!='undefined';client_payment_ids.push(elements[i++].getAttribute('value')));
 $input.val(client_payment_ids);
});

$("form.payment_fractionated").submit(function(){
 var $input = $(this).find("input[name='payment_fractionated[ids]']");
 var elements = $( "input.checkbox-slave:checked" );
 var instalments_ids = [];
 for(var i=0;typeof(elements[i])!='undefined';instalments_ids.push(elements[i++].getAttribute('value')));
 $input.val(instalments_ids);
});

$("#pages a").on("click", function() {
  $.getScript(this.href);
  return false;
});
