<script>
$(document).ready(function () {
  var _thisForm = '';
  var changing = false;

  $(document).ready(function() {
    $('.sel2').select2({
      formatNoMatches: function(m) { return '<%= I18n.t("select2.no_matches") %>'; },
      dropdownCssClass: 'shrinked',
      dropdownAutoWidth: true,
      allowClear: true
    });
    $('.sel3').select2({
      formatNoMatches: function(m) { return '<%= I18n.t("select2.no_matches") %>'; },
      dropdownCssClass: 'shrinked',
      dropdownAutoWidth: true,
      allowClear: true
    });
    // Initialized form variable
    _thisForm = $("#removeFilter").closest('form')[0];
  });


  $(document).ajaxStart(function() {
    // show loader on start
    if (changing == false) {
      $("#pendings").html("");
      $("#unpaid").html("");
      $("#charged").html("");
      $("#cash").html("");
      $("#banks").html("");
      $("#others").html("");
      $("#fractionated").html("");
      $("#loader").show();
    }
  }).ajaxSuccess(function() {
    // hide loader on success
    $("#loader").hide();
  });

  $(window).bind("load", function() {
    $("#bill_no").val("<%= params[:bill_no] %>");
    $("#project").select2("val", "<%= params[:project] %>");
    $("#client").select2("val", "<%= params[:client] %>");
    $("#subscriber").select2("val", "<%= params[:subscriber] %>");
    $("#entity").select2("val", "<%= params[:entity] %>");
    $("#bank_account").select2("val", "<%= params[:bank_account] %>");
    $("#billing_period").select2("val", "<%= params[:billing_period] %>");
    $("#reading_routes").select2("val", "<%= params[:reading_routes] %>");
  });

  jQuery(function($) {
    $("#removeFilter").click(function() {
      $("#bill_no").val("");
      $("#project").select2("val", "");
      $("#client").select2("val", "");
      $("#subscriber").select2("val", "");
      $("#entity").select2("val", "");
      $("#bank_account").select2("val", "");
      $("#billing_period").select2("val", "");
      $("#reading_routes").select2("val", "");
      // no AJAX
      //_thisForm.submit();
      // AJAX
      $("#submit_btn").trigger("click");
    });
  });
  // Date picker
  $('.date_picker').datepicker({
    format : 'dd/mm/yyyy',
    weekStart : 1
  }).on('changeDate', function(e){
    $('.date_picker').datepicker('hide');
  });

  $('#payments-tabs a').click(function (e) {
    e.preventDefault();
    $('input:checkbox').removeAttr('checked');
    $(this).tab('show');
  });

  $('.accor').click(function () {
    if (this.classList.contains("collapsed")){
      this.children[0].className = "icon-minus";
    }else {
      this.children[0].className = "icon-plus";
    }
  });

  $(".btn-payment").click(function(){
    var elements = $( "input:checked" );
    var invoices_id = [];
    var debts_array = [];
    for(var i=0;typeof(elements[i])!='undefined';invoices_id.push(elements[i++].getAttribute('value')));
    for(var i=0;typeof(elements[i])!='undefined';debts_array.push(elements[i++].getAttribute('data-debt')));
    var total_debt = 0.0;
    for (var i = 0; i < debts_array.length; i++) {
      if(debts_array[i] != null){
        total_debt += parseFloat(debts_array[i]);
      }
    }
    $(".debt-total").text(total_debt);
    $("#client_payment_invoices_ids").val(invoices_id.filter(i=>i!=null))
    $("#client_payment_bank_invoices_ids").val(invoices_id.filter(i=>i!=null))
    $("#instalment_invoices_ids").val(invoices_id.filter(i=>i!=null))
  });

  $(".btn-others").click(function (e) {
    $(".client_payment_payment_method_id").show();
    $("#client_payment_payment_method_id").prop('disabled', false);
  });

  $(".btn-cash").click(function (e) {
    $(".client_payment_payment_method_id").hide();
    $("#client_payment_payment_method_id").prop('disabled', true);
  });

  $(".checkbox-master").click(function () {
    $(this).parents(".accordion").find("tbody").find("input[type=checkbox]").prop('checked', $(this).prop('checked'));
  });

  $(".checkbox-master-table").click(function () {
    $(this).parents(".table").find("tbody").find("input[type=checkbox]").prop('checked', $(this).prop('checked'));
  });

  $(".checkbox-main").click(function () {
    $(".checkbox-slave, .checkbox-master:not(:disabled)").prop('checked', $(this).prop('checked'));
  });


  $("#client_payment_amount").change(function() {
    amount = this.value
    debt = jQuery(this).parents(".modal").find(".debt-total").text()
    $(".cash-return").text((amount - debt).toFixed(2))
  })

  $("#initial-cash").change(function() {
    initialCash = parseFloat(this.value)
    cashed = parseFloat($("#total-cash").text());
    $("#ending-cash").text((initialCash + cashed).toFixed(2));
  })

  $("form.bank_confirm").submit(function(){
   var $input = $(this).find("input[name='bank_confirm[ids]']");
   var elements = $( "input.checkbox-slave:checked" );
   var client_payment_ids = [];
   for(var i=0;typeof(elements[i])!='undefined';client_payment_ids.push(elements[i++].getAttribute('value')));
   $input.val(client_payment_ids);
  });

  $("form.payment_fractionated").submit(function(){
   var $input = $(this).find("input[name='payment_fractionated[ids]']");
   var elements = $( "input.checkbox-slave:checked" );
   var instalments_ids = [];
   for(var i=0;typeof(elements[i])!='undefined';instalments_ids.push(elements[i++].getAttribute('value')));
   $input.val(instalments_ids);
  });

  $("#pages a").on("click", function() {
    $.getScript(this.href);
    return false;
  });

   // when #report_btn is clicked
    $("#print_report_btn").click(function() {
      // make a POST call and get report
      var report = $('#Report :selected').index();
      if (report == "")
        return;
      switch (report) {
        case 1:
          // bill
          window.open("bill_report.pdf", "_blank");
          return false;
          break;

          case 2:
          // bill pending
          window.open("bill_pending_report.pdf", "_blank");
          return false;
          break;

          case 3:
          // bill unpaid
          window.open("bill_unpaid_report.pdf", "_blank");
          return false;
          break;

          case 4:
          // bill charged
          window.open("bill_charged_report.pdf", "_blank");
          return false;
          break;

          case 5:
          // client_payment
          window.open("client_payment_report.pdf", "_blank");
          return false;
          break;
      }
      return false;
  });

});
</script>



<style>
  .accordion{
    background-color: white !important;
  }
  .tab-pane{
    width: 95%;
    padding: 15px;
  }
  #pendings, #unpaid, #charged{
    background-color: #FDE3A7;
  }
  #cash, #banks, #others ,#fractionated{
    background-color: #FFCCBC;
  }
  .checkbox-master{
    margin-top: 12px !important;
    margin-left: 5px !important;
  }
</style>

<%= render '/layouts/ag2_gest/clientpaymentsbreadcrumb' %>

<h3><%= 'Cobros' %></h3>

<div class="container-fluid">
  <div class="row-fluid">

    <div class="span3">
      <div class="well sidebar-nav">
        <!-- Refresh -->
        <%= link_to ag2_gest.client_payments_path, title: I18n.t(:refresh), class: "icon-refresh-link", remote: true do %><i class="icon-refresh"></i><% end %>
        <!-- Search form -->
        <%= form_tag "client_payments", :method => 'get', :remote => true do %>

          <%= label_tag "Factura", nil, :class => 'form-label' %>
          <%= text_field_tag "bill_no", nil, :class => 'x-large-text-field shrinked number-text-field', onkeyup: "caps(this)" %>

          <!-- Client -->
          <%= label_tag I18n.t("ag2_gest.contracting_requests.index.label_client"), nil, :class => 'form-label' %>
          <%= select_tag "client", options_from_collection_for_select(@clients, "id", "to_label"), :prompt => "", :class => 'x-large-text-field shrinked sel2' %>

          <!-- Subscriber -->
          <%= label_tag I18n.t("ag2_gest.contracting_requests.index.label_subscriber"), nil, :class => 'form-label-under-sel2' %>
          <%= select_tag "subscriber", options_from_collection_for_select(@subscribers, "id", "to_label"), :prompt => "", :class => 'x-large-text-field shrinked sel2' %>

          <!-- Entity -->
          <%= label_tag I18n.t("ag2_gest.contracting_requests.index.label_entity"), nil, :class => 'form-label-under-sel2' %>
          <%= select_tag "entity", options_from_collection_for_select(@entities, "id", "to_label"), :prompt => "", :class => 'x-large-text-field shrinked sel2' %>

          <!-- Project -->
          <%= label_tag I18n.t("ag2_gest.contracting_requests.index.label_project"), nil, :class => 'form-label-under-sel2' %>
          <%= select_tag "project", options_from_collection_for_select(@projects, "id", "project_code"), :prompt => "", :class => 'x-large-text-field shrinked sel2' %>

          <!-- BankAccount -->
          <%= label_tag I18n.t("ag2_gest.contracting_requests.index.label_bank_account"), nil, :class => 'form-label-under-sel2' %>
          <%= select_tag "bank_account", options_for_select([ "SI", "NO" ]), include_blank: true, :prompt => "", :class => 'x-large-text-field shrinked sel2' %>

          <!-- Period -->
          <%= label_tag I18n.t("ag2_gest.contracting_requests.index.label_billing_period"), nil, :class => 'form-label-under-sel2' %>
          <%= select_tag "billing_period", options_from_collection_for_select(@billing_periods, "id", "period"), :prompt => "", :class => 'x-large-text-field shrinked sel2' %>

          <!-- Ruta -->
          <%#= label_tag "Ruta", nil, :class => 'form-label-under-sel2' %>
          <%#= select_tag "reading_routes", options_from_collection_for_select(@reading_routes, "id", "name"), :prompt => "", :class => 'x-large-text-field shrinked sel2' %>

          <br /><br />
          <!-- Submit -->
          <%= submit_tag I18n.t(:apply_filter_button), :class => 'btn btn-primary', :id => 'submit_btn' %>


          <!-- Remove filter -->
          <button id="removeFilter" type="button" class="btn btn-primary" data-dismiss="modal" aria-hidden="true"><%= t :clear_filter_button %></button>

        <% end %>

      <!-- Report -->
      <%= label_tag I18n.t("ag2_gest.client_payments.report.report"), nil, :class => 'form-label-under-sel2' %>
      <%= select_tag "Report", options_for_select(@reports), :prompt => "", :class => 'x-large-text-field shrinked sel3' %>
        <br /><br />
        <!-- Control&Tracking -->
        <a href="#" id="print_report_btn" class="btn btn-warning"><i class="icon-print icon-white"></i> <%= t 'ag2_gest.home.index.control' %></a>
        <br /><br />

        <!-- <br /> -->
        <%= link_to t(".back_to_root"), ag2_gest.root_path %>
      </div><!-- /.sidebar-nav -->
    </div><!-- /.span3 -->

    <div class="span9" id="div_table">
      <div id="div_table">
        <div class="span6 text-center"><h4>Facturas</h4></div>
        <div class="span6 text-center"><h4>Cobros</h4></div>
        <ul class="nav nav-tabs" id="payments-tabs">
          <li class="active" style="width:25%"><a href="#pendings">Pendientes</a></li>
          <!-- <li style="width:16%"><a href="#unpaid">Impagadas</a></li> -->
          <li style="width:25%"><a href="#charged">Cobradas</a></li>
          <li class="pull-right"><a href="#fractionated">Aplazamientos</a></li>
          <li class="pull-right"><a href="#others">Otros</a></li>
          <li class="pull-right"><a href="#banks">Bancos</a></li>
          <li class="pull-right"><a href="#cash">Caja</a></li>
        </ul>

        <div class="tab-content">
          <div id="loader"></div>
        <!-- PENDING TAB -->
          <div class="tab-pane active" id="pendings">
            <%= render 'bills_pendings' %>
          </div>

          <!-- IMPAID TAB -->
          <!-- <div class="tab-pane" id="unpaid">
            <%#= render 'bills_unpaid' %>
          </div> -->

          <!-- CHARGED TAB -->
          <div class="tab-pane" id="charged">
            <%= render 'bills_charged' %>
          </div>

          <!-- CASH TAB -->
          <div class="tab-pane" id="cash">
            <%= render 'payments_cash' %>
          </div>

          <!-- BANK TAB -->
          <div class="tab-pane" id="banks">
            <%= render 'payments_bank' %>
          </div>

          <!-- OTHERS TAB -->
          <div class="tab-pane" id="others">
            <%= render 'payments_other' %>
          </div>

          <!-- FRACTIONATED TAB -->
          <div class="tab-pane" id="fractionated">
            <%= render 'instalments' %>
          </div>

        </div>
      </div>
    </div>



    <!-- Modal Cash / Others -->
    <div id="modal-cash" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="ConfirmarBills" aria-hidden="true">
      <div class="modal-header">
        <h4>Caja/Otros</h4>
      </div>
      <%= simple_form_for :client_payment, url: cash_others_client_payments_path, method: :post do |f| %>
        <div class="modal-body">
          <%= f.input :invoices_ids, :as => :hidden %>
          <div class="control-group string required meter_manufacturing_date">
            <label class="string control-label">Total</label>
            <div class="controls">
              <span class="debt-total">0</span>
            </div>
          </div>
          <%= f.input :amount, label: I18n.t("ag2_gest.client_payments.index.amount"), as: "decimal", inline_label: "Yes" %>
          <%= f.input :payment_method_id, collection: PaymentMethod.all, inline_label: "Yes" %>
          <div class="control-group string required meter_manufacturing_date">
            <label class="string control-label">Vuelta</label>
            <div class="controls">
              <span class="cash-return">0</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <%= f.button :submit, "Confirmar", :class => 'btn btn-primary' %>
          <button class="btn" data-dismiss="modal" aria-hidden="true">Cerrar</button>
        </div>
      <% end %>
    </div>

    <!-- Modal Bank -->
    <div id="modal-bank" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="ConfirmarBills" aria-hidden="true">
      <div class="modal-header">
        <h4>Banco</h4>
      </div>
      <%= simple_form_for :client_payment_bank, url: banks_client_payments_path, method: :post do |f| %>
        <div class="modal-body">
          <%= f.input :invoices_ids, :as => :hidden %>
          <div class="control-group string required meter_manufacturing_date">
            <label class="string control-label">Total</label>
            <div class="controls">
              <span class="debt-total">0</span>
            </div>
          </div>
          <%= f.input :receipt_no, label: I18n.t("ag2_gest.client_payments.index.receipt_no"), as: "string", inline_label: "Yes" %>
        </div>
        <div class="modal-footer">
          <%= f.button :submit, "Confirmar", :class => 'btn btn-primary' %>
          <button class="btn" data-dismiss="modal" aria-hidden="true">Cerrar</button>
        </div>
      <% end %>
    </div>

    <!-- Modal Fractionated -->
    <div id="modal-fracionated" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="ConfirmarBills" aria-hidden="true">
      <div class="modal-header">
        <h4>Aplazamiento</h4>
      </div>
      <%= simple_form_for :instalment, url: fractionated_client_payments_path, method: :post do |f| %>
        <div class="modal-body">
          <%= f.input :invoices_ids, :as => :hidden %>
          <div class="control-group string required meter_manufacturing_date">
            <label class="string control-label">Total</label>
            <div class="controls">
              <span class="debt-total">0</span>
            </div>
          </div>
          <%= f.input :number_inst, label: "Plazos", as: "string", inline_label: "Yes" %>
          <%= f.input :charge, label: "Porcentaje de recargo", as: "string", inline_label: "Yes" %>
        </div>
        <div class="modal-footer">
          <%= f.button :submit, "Confirmar", :class => 'btn btn-primary' %>
          <button class="btn" data-dismiss="modal" aria-hidden="true">Cerrar</button>
        </div>
      <% end %>
    </div>

    <!-- Modal Close Cash -->
    <div id="modal-close-cash" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="CerrarCaja" aria-hidden="true">
      <div class="modal-header">
        <h4>Cerrar Caja</h4>
      </div>
      <%= simple_form_for :close_cash, url: close_cash_client_payments_path, method: :post do |f| %>
        <div class="modal-body">

          <div class="control-group string required meter_manufacturing_date">
            <label class="string control-label">Saldo de apertura</label>
            <div class="controls">
              <input id="initial-cash" size="50" type="number" step="0.01">
            </div>
          </div>

          <div class="control-group string required meter_manufacturing_date">
            <label class="string control-label">Total cobrado</label>
            <div class="controls">
              <span id="total-cash"><%= @client_payments_cash.sum{|c| c.amount} %></span>
            </div>
          </div>

          <div class="control-group string required meter_manufacturing_date">
            <label class="string control-label">Saldo de cierre</label>
            <div class="controls">
              <span id="ending-cash" size="50" type="number" step="0.01"><%= @client_payments_cash.sum{|c| c.amount} %></span>
            </div>
          </div>

        </div>
        <div class="modal-footer">
          <%= f.button :submit, "Confirmar", :class => 'btn btn-primary' %>
          <button class="btn" data-dismiss="modal" aria-hidden="true">Cerrar</button>
        </div>
      <% end %>
    </div>

  </div>
</div>
