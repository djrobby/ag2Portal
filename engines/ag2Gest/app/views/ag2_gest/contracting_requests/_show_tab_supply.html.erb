<style type="text/css">
  .disabled a:hover{
    color: #aaa;
    cursor: not-allowed !important;
  }
  .disabled:hover{
    color: #fff;
  }
  .disabled:focus{
    color: #fff;
    background-color: white;
  }
  #billing-modal{
    width: 880px !important;
    left: 40% !important;
  }
  #billing-modal-cancellation{
    width: 880px !important;
    left: 40% !important;
  }
  #billing-bailback-modal-cancellation{
    width: 880px !important;
    left: 40% !important;
  }
  #billing-unsubscribe-modal-cancellation{
    width: 880px !important;
    left: 40% !important;
  }
  .stepwizard-step p {
          margin-top: 10px;
      }

      .step-refresh {
        margin-right: 20px;
      }

      .stepwizard-row {
          display: table-row;
      }

      .stepwizard {
          display: table;
          width: 100%;
          position: relative;
      }

      .stepwizard-step button[disabled] {
          opacity: 1 !important;
          filter: alpha(opacity=100) !important;
      }

      .stepwizard-row:before {
          top: 14px;
          bottom: 0;
          position: absolute;
          content: " ";
          width: 100%;
          height: 1px;
          background-color: #ccc;
          z-order: 0;

      }

      .stepwizard-step {
          display: table-cell;
          text-align: center;
          position: relative;
      }

      .btn-circle {
        width: 30px;
        text-align: center;
        padding: 6px 0;
        font-size: 12px;
        line-height: 1.428571429;
        border-radius: 15px;
      }
      .disabled {
         display:inline-block;
          pointer-events: none;
      }

      .text-active{
        color: #006ccc;
      }

      .text-inactive{
        color: #ccc;
      }

      #billing-modal {
        width: 1020px !important;
        left: 32% !important;
      }

      #billing-modal-cancellation {
        width: 1020px !important;
        left: 32% !important;
      }
      #billing-bailback-modal-cancellation {
        width: 1020px !important;
        left: 32% !important;
      }
      #billing-unsubscribe-modal-cancellation {
        width: 1020px !important;
        left: 32% !important;
      }

      #billing-modal td {
        text-align: center!important;
        width: 12%;
      }

      #billing-modal-cancellation td {
        text-align: center!important;
        width: 12%;
      }
      #billing-bailback-modal-cancellation td {
        text-align: center!important;
        width: 12%;
      }
      #billing-unsubscribe-modal-cancellation td {
        text-align: center!important;
        width: 12%;
      }
</style>
<script type="text/javascript">

  $(document).ready(function () {
  // Select2
  $('select.sel2').select2({
    formatNoMatches: function(m) { return '<%= I18n.t("select2.no_matches") %>'; },
    allowClear: true
  });
  // Date picker
  $('.date_picker').datepicker({
    format : 'dd/mm/yyyy',
    weekStart : 1
  }).on('changeDate', function(e){
    $('.date_picker').datepicker('hide');
  });
  // WIZARD FORM
    // var navListItems = $('div.setup-panel div a'),
    //     pListItems = $('div.setup-panel div p'),
    //     allWells = $('.setup-content'),
    //     allNextBtn = $('.nextBtn');
    //     // allPrevBtn = $('.prevBtn');

    // allWells.hide();
    // $(".btn-circle[disabled!='disabled']").addClass('btn-primary');
    // $(".btn-circle[disabled!='disabled']").siblings("p").removeClass("text-inactive").addClass("text-active")

    // navListItems.click(function (e) {
    //     e.preventDefault();
    //     var $target = $($(this).attr('href')),
    //         $item = $(this);

    //     if (!($item.attr("disabled") == "disabled")) {
    //         navListItems.removeClass('btn-primary').addClass('btn-default').attr("disabled","disabled");
    //         pListItems.removeClass("text-active").addClass("text-inactive")
    //         $item.addClass('btn-primary').removeAttr("disabled");
    //         $item.siblings("p").removeClass("text-inactive").addClass("text-active")
    //         allWells.hide();
    //         $target.show();
    //         $target.find('input:eq(0)').focus();
    //     }
    // });

    // // allNextBtn.click(function(){
    //   allNextBtn.attr('href', "/<%= params[:locale] %>/ag2_gest/<%= params[:locale] %>/contracting_requests/<%= @contracting_request.id %>/next_status")

    //   allNextBtn.bind("ajax:success", function(xhr, data, status) {
    //     var curStep = $(this).closest(".setup-content"),
    //         curStepBtn = curStep.attr("id"),
    //         currentStepWizard = $('div.setup-panel div a[href="#' + curStepBtn + '"]').parent().children("a"),
    //         nextStepWizard = $('div.setup-panel div a[href="#' + curStepBtn + '"]').parent().next().children("a"),
    //         curInputs = curStep.find("input[type='text'],input[type='url']");
    //         // isValid = true;
    //     // $(".form-group").removeClass("has-error");
    //     // for(var i=0; i<curInputs.length; i++){
    //     //     if (!curInputs[i].validity.valid){
    //     //         isValid = false;
    //     //         $(curInputs[i]).closest(".form-group").addClass("has-error");
    //     //     }
    //     // }

    //     // Fill fields for client
    //     <% unless @contracting_request.client %>
    //       $("#link_client").attr("href","/<%= params[:locale] %>/ag2_gest/<%= params[:locale] %>/clients/" + data.client.id);
    //       $("#link_client").text(data.client.client_code.substr(0, 3) + "-" + data.client.client_code.substr(3));
    //     <% end %>

    //     // if (isValid)
    //     currentStepWizard
    //     currentStepWizard.siblings("p").removeClass("text-active")
    //     nextStepWizard.siblings("p").removeClass("text-inactive").addClass("text-active")
    //     nextStepWizard.removeAttr('disabled').trigger('click');
    // });

    // // allPrevBtn.click(function(){
    // //     var curStep = $(this).closest(".setup-content"),
    // //         curStepBtn = curStep.attr("id"),
    // //         currentStepWizard = $('div.setup-panel div a[href="#' + curStepBtn + '"]').parent().children("a"),
    // //         prevStepWizard = $('div.setup-panel div a[href="#' + curStepBtn + '"]').parent().prev().children("a"),
    // //         curInputs = curStep.find("input[type='text'],input[type='url']"),
    // //         isValid = true;

    // //     $(".form-group").removeClass("has-error");

    // //     if (isValid)
    // //         currentStepWizard.siblings("p").removeClass("text-active")
    // //         prevStepWizard.siblings("p").addClass("text-active")
    // //         prevStepWizard.trigger('click');
    // // });

    var navListItems = $('div.setup-panel div a'),
        pListItems = $('div.setup-panel div p'),
        allWells = $('.setup-content'),
        allNextBtn = $('.nextBtn');
        // allPrevBtn = $('.prevBtn');

    allWells.hide();
    $(".btn-circle[disabled!='disabled']").addClass('btn-primary');
    $(".btn-circle[disabled!='disabled']").siblings("p").removeClass("text-inactive").addClass("text-active")

    navListItems.click(function (e) {
        e.preventDefault();
        var $target = $($(this).attr('href')),
            $item = $(this);

        if (!($item.attr("disabled") == "disabled")) {
            navListItems.removeClass('btn-primary').addClass('btn-default').attr("disabled","disabled");
            pListItems.removeClass("text-active").addClass("text-inactive")
            $item.addClass('btn-primary').removeAttr("disabled");
            $item.siblings("p").removeClass("text-inactive").addClass("text-active")
            allWells.hide();
            $target.show();
            $target.find('input:eq(0)').focus();
        }
    });


    var changeState = function(current, next){
      current
      current.siblings("p").removeClass("text-active")
      next.siblings("p").removeClass("text-inactive").addClass("text-active")
      next.removeAttr('disabled').trigger('click');
    };

    $("#form_new_water_supply_contract").bind("ajax:success", function(xhr, data, status) {
      $("#modal-data").modal('hide');
    });

    $("#form_new_cancellation").bind("ajax:success", function(xhr, data, status) {
      $("#modal-data").modal('hide');
    });

    $("#form_add_concept").bind("ajax:success", function(xhr, data, status) {
      $("#modal-data").modal('hide');
    });

    // ajax success for initial_inspection
    $("#initial-inspection").bind("ajax:success", function(xhr, data, status) {
      var currentStepWizard = $('a[href="#step-1"]'),
          nextStepWizard = $('a[href="#step-2"]');
      changeState(currentStepWizard,nextStepWizard)
      $("#link_work_order_inspection").attr("href","/<%= params[:locale] %>/ag2_tech/<%= params[:locale] %>/work_orders/" + data.work_order.id);
      $("#link_work_order_inspection").text(data.work_order.order_no.substr(0, 12) + "-" + data.work_order.order_no.substr(12, 4) + "-" +  data.work_order.order_no.substr(16, 6));
      $("#status_work_order_inspection").text(data.work_order_status.name);
    });

    $("#ot-cancellation").bind("ajax:success", function(xhr, data, status) {
      $("#link_work_order_inspection").attr("href","/<%= params[:locale] %>/ag2_tech/<%= params[:locale] %>/work_orders/" + data.work_order.id);
      $("#link_work_order_inspection").text(data.work_order.order_no.substr(0, 12) + "-" + data.work_order.order_no.substr(12, 4) + "-" +  data.work_order.order_no.substr(16, 6) + "M");
      $("#status_work_order_inspection").text(data.work_order_status.name);
      $("#link_work_order_cancellation").attr("href","/<%= params[:locale] %>/ag2_tech/<%= params[:locale] %>/work_orders/" + data.work_order_cancellation.id);
      $("#link_work_order_cancellation").text(data.work_order_cancellation.order_no.substr(0, 12) + "-" + data.work_order_cancellation.order_no.substr(12, 4) + "-" +  data.work_order_cancellation.order_no.substr(16, 6));
      $("#status_work_order_cancellation").text(data.work_order_status_cancellation.name);
      $("#ot-cancellation").addClass('btn btn-primary nextBtn').attr("disabled","disabled");
    });

    $("#ot-installation").bind("ajax:success", function(xhr, data, status) {
      $("#link_work_order_inspection").attr("href","/<%= params[:locale] %>/ag2_tech/<%= params[:locale] %>/work_orders/" + data.work_order.id);
      $("#link_work_order_inspection").text(data.work_order.order_no.substr(0, 12) + "-" + data.work_order.order_no.substr(12, 4) + "-" +  data.work_order.order_no.substr(16, 6) + "M");
      $("#status_work_order_inspection").text(data.work_order_status.name);
      $("#link_work_order_installation").attr("href","/<%= params[:locale] %>/ag2_tech/<%= params[:locale] %>/work_orders/" + data.work_order_installation.id);
      $("#link_work_order_installation").text(data.work_order_installation.order_no.substr(0, 12) + "-" + data.work_order_installation.order_no.substr(12, 4) + "-" +  data.work_order_installation.order_no.substr(16, 6));
      $("#status_work_order_installation").text(data.work_order_status_installation.name);
      $("#ot-installation").addClass('btn btn-primary nextBtn').attr("disabled","disabled");
      $("#new-subscriber-installation").removeClass("disabled");
    });

    $("#initial-complete").bind("ajax:success", function(xhr, data, status) {
      var currentStepWizard = $('a[href="#step-1"]'),
          nextStepWizard = $('a[href="#step-5"]');
      changeState(currentStepWizard,nextStepWizard)
    });
    
    $("#refresh-status").bind("ajax:success", function(xhr, data, status) {

      if (data.client_debt) {
        $("#debt").text(data.client_debt);
      };

      if (data.work_order) {
        $("#link_work_order_inspection").attr("href","/<%= params[:locale] %>/ag2_tech/<%= params[:locale] %>/work_orders/" + data.work_order.id);
        $("#link_work_order_inspection").text(data.work_order.order_no.substr(0, 12) + "-" + data.work_order.order_no.substr(12, 4) + "-" +  data.work_order.order_no.substr(16, 6));
      };
      
      if (data.work_order_status) {
        $("#status_work_order_inspection").text(data.work_order_status.name);
      };

      if (data.meter_code) {
        $("#meter_code").val(data.meter_code);
      };

      if (data.caliber) {
        $("#caliber").val(data.caliber.caliber);
      };

      if (data.meter_installation) {
        $("#sel2_association_change").val(data.meter_installation.id);
      };

      if (data.meter_code_installation) {
        $("#input_change_meter").val(data.meter_code_installation);
      };

      if (data.meter_location_installation) {
        $("#meter-location-new-subscriber").select2("val",data.meter_location_installation.id);
      };

      if (data.reading_date_installation) {
        $("#installation-date-new-subscriber").val(data.reading_date_installation);
      };

      if (data.reading_index_installation) {
        $("#installation-reading-new-subscriber").val(data.reading_index_installation);
      };

      if (data.reading_date_cancellation) {
        $("#cancellation-date").val(data.reading_date_cancellation);
      };

      if (data.reading_index_cancellation) {
        $("#cancellation-index").val(data.reading_index_cancellation);
      };

      if (data.work_order_cancellation) {
        $("#link_work_order_inspection").text(data.work_order.order_no.substr(0, 12) + "-" + data.work_order.order_no.substr(12, 4) + "-" +  data.work_order.order_no.substr(16, 6) + "M");
        $("#link_work_order_cancellation").attr("href","/<%= params[:locale] %>/ag2_tech/<%= params[:locale] %>/work_orders/" + data.work_order_cancellation.id);
        $("#link_work_order_cancellation").text(data.work_order_cancellation.order_no.substr(0, 12) + "-" + data.work_order_cancellation.order_no.substr(12, 4) + "-" +  data.work_order_cancellation.order_no.substr(16, 6));
      };
      if (data.work_order_status_cancellation) {
        $("#status_work_order_cancellation").text(data.work_order_status_cancellation.name);
      };

      if (data.work_order_installation) {
        $("#link_work_order_inspection").text(data.work_order.order_no.substr(0, 12) + "-" + data.work_order.order_no.substr(12, 4) + "-" +  data.work_order.order_no.substr(16, 6) + "M");
        $("#link_work_order_installation").attr("href","/<%= params[:locale] %>/ag2_tech/<%= params[:locale] %>/work_orders/" + data.work_order_installation.id);
        $("#link_work_order_installation").text(data.work_order_installation.order_no.substr(0, 12) + "-" + data.work_order_installation.order_no.substr(12, 4) + "-" +  data.work_order_installation.order_no.substr(16, 6));
      };
      if (data.work_order_status_installation) {
        $("#status_work_order_installation").text(data.work_order_status_installation.name);
          $("#new-subscriber-installation").removeClass("disabled");
          // if (data.work_order_status_installation.id == '3' || data.work_order_status_installation.id == '4') {
          //   $("#new-subscriber-installation").removeClass("disabled");
          // } else {
          //   $("#new-subscriber-installation").addClass("disabled");
          // };
      };

      if (data.invoice_status) {
        if (data.invoice_status.id != '1' && !data.work_order_installation) {
          $("#ot-installation").removeClass("disabled");
        } else {
          $("#ot-installation").addClass("disabled");
        };
        if (data.invoice_status.id != '1') {
          $("#link-bill-span").hide();
        } else {
          $("#link-bill-span").show();
          $("#link-bill-span").text(data.invoice_status.code);
        };
      };

      if (data.invoice_status_cancellation) {
        if (data.invoice_status_cancellation.id != '1') {
          $("#link-unsubscribe-bill-span").hide();
        } else {
          $("#link-unsubscribe-bill-span").show();
          $("#link-unsubscribe-bill-span").text(data.invoice_status_cancellation.code);
        };
      };

    });

    // ajax success for initial_billing
    $("#initial-billing").bind("ajax:success", function(xhr, data, status) {
      var currentStepWizard = $('a[href="#step-1"]'),
          nextStepWizard = $('a[href="#step-3"]');
      changeState(currentStepWizard,nextStepWizard)
      $("#update-new").hide();
      $("#new").show();
      $("#bill-doc").addClass("hide");
      $("#link-bill").addClass("hide");
    });

    $("#initial-billing-cancellation").bind("ajax:success", function(xhr, data, status) {
      var currentStepWizard = $('a[href="#step-1"]'),
          nextStepWizard = $('a[href="#step-3"]');
      if (data.reading){
        alert('<%= t('ag2_gest.contracting_requests.reading_cancellation_billable') %>');
      } else {
        changeState(currentStepWizard,nextStepWizard)
        $("#update-new").hide();
        $("#new").show();
      };
    });

    $("#inspection-billing-cancellation").bind("ajax:success", function(xhr, data, status) {
      var currentStepWizard = $('a[href="#step-2"]'),
          nextStepWizard = $('a[href="#step-3"]');
      if (data.reading){
        alert('<%= t('ag2_gest.contracting_requests.reading_cancellation_billable') %>');
      } else {
        changeState(currentStepWizard,nextStepWizard)
        $("#update-new").hide();
        $("#new").show();
      };
    });

    // ajax success for initial_billing
    $("#inspection-billing").bind("ajax:success", function(xhr, data, status) {
      var currentStepWizard = $('a[href="#step-2"]'),
          nextStepWizard = $('a[href="#step-3"]');
      changeState(currentStepWizard,nextStepWizard)
      $("#update-new").hide();
      $("#new").show();
      $("#bill-doc").addClass("hide");
      $("#link-bill").addClass("hide");
    });


    // ajax success for inspection_billing
    // $("#inspection-billing").bind("ajax:success", function(xhr, data, status) {
    //   var currentStepWizard = $('a[href="#step-2"]'),
    //       nextStepWizard = $('a[href="#step-3"]');
    //   changeState(currentStepWizard,nextStepWizard)
    //   $("#link-bill").attr("href","/<%= params[:locale] %>/ag2_gest/<%= params[:locale] %>/bills/" + data.bill.id);
    //   $("#link-bill").text(data.bill.bill_no.substr(0, 12) + "-" + data.bill.bill_no.substr(12, 4) + "-" +  data.bill.bill_no.substr(16, 6));
    //   $("#bill-doc").removeClass("hide");
    // });


    $("#billing-complete").bind("ajax:success", function(xhr, data, status) {
      var currentStepWizard = $('a[href="#step-3"]'),
          nextStepWizard = $('a[href="#step-5"]');
      changeState(currentStepWizard,nextStepWizard);
    });

    // ajax success for billing_instalation
    $("#billing-instalation").bind("ajax:success", function(xhr, data, status) {
      var currentStepWizard = $('a[href="#step-3"]'),
          nextStepWizard = $('a[href="#step-4"]');
      changeState(currentStepWizard,nextStepWizard);
      $("#link-bill").removeClass("hide");
      $("#link-bill").attr("href","/<%= params[:locale] %>/ag2_gest/<%= params[:locale] %>/client_payments?BillNo=" + data.bill.bill_no);
      $("#link-bill").text(data.bill_no);
      $("#bill-doc").removeClass("hide");
      $("#bill-doc").attr("href","/<%= params[:locale] %>/ag2_gest/<%= params[:locale] %>/bills/" + data.bill.id + "/biller_contract_pdf.pdf");
      if (data.work_order_status.id == '1' || data.work_order_status.id == '2'){
        alert('<%= t('activerecord.attributes.contracting_request.alert_inspection') %>');
      };
      if (data.invoice_status.id != '1' && !data.work_order_installation) {
        $("#ot-installation").removeClass("disabled");
      } else {
        $("#ot-installation").addClass("disabled");
      };
      if (data.invoice_status.id != '1') {
        $("#link-bill-span").hide();
      } else {
        $("#link-bill-span").show();
        $("#link-bill-span").text(data.invoice_status.code);
      };
      // $("#link_work_order_instalation").attr("href","/<%= params[:locale] %>/ag2_tech/<%= params[:locale] %>/work_orders/" + data.work_order.id);
      // $("#link_work_order_instalation").text(data.work_order.order_no.substr(0, 12) + "-" + data.work_order.order_no.substr(12, 4) + "-" +  data.work_order.order_no.substr(16, 6));
      // $("#status_work_order_instalation").text(data.work_order_status.name);
    });

    $("#billing-instalation-cancellation").bind("ajax:success", function(xhr, data, status) {
      var currentStepWizard = $('a[href="#step-3"]'),
          nextStepWizard = $('a[href="#step-4"]');
      changeState(currentStepWizard,nextStepWizard);
      if (data.bailback_bill) {
        $("#link-bailback-bill").attr("href","/<%= params[:locale] %>/ag2_gest/<%= params[:locale] %>/client_payments?BillNo=" + data.bailback_bill.bill_no);
        $("#link-bailback-bill").text(data.bailback_bill_no);
        $("#bailback-bill-doc").removeClass("hide");
        $("#bailback-bill-doc").attr("href","/<%= params[:locale] %>/ag2_gest/<%= params[:locale] %>/bills/" + data.bailback_bill.id + "/biller_contract_pdf.pdf");
      };
      $("#link-unsubscribe-bill").attr("href","/<%= params[:locale] %>/ag2_gest/<%= params[:locale] %>/client_payments?BillNo=" + data.unsubscribe_bill.bill_no);
      $("#link-unsubscribe-bill").text(data.unsubscribe_bill_no);
      $("#unsubscribe-bill-doc").removeClass("hide");
      $("#unsubscribe-bill-doc").attr("href","/<%= params[:locale] %>/ag2_gest/<%= params[:locale] %>/bills/" + data.unsubscribe_bill.id + "/biller_pdf.pdf");
      if (data.bill) {
        $("#link-bill").removeClass("hide");
        $("#link-bill").attr("href","/<%= params[:locale] %>/ag2_gest/<%= params[:locale] %>/client_payments?BillNo=" + data.bill.bill_no);
        $("#link-bill").text(data.bill_no);
        $("#bill-doc").removeClass("hide");
        $("#bill-doc").attr("href","/<%= params[:locale] %>/ag2_gest/<%= params[:locale] %>/bills/" + data.bill.id + "/biller_contract_pdf.pdf");
      };
      $("#link-unsubscribe-bill-span").show();
      $("#link-unsubscribe-bill-span").text(data.invoice_status_cancellation.code);
      
      if (data.work_order_status.id == '1' || data.work_order_status.id == '2'){
        alert('<%= t('activerecord.attributes.contracting_request.alert_inspection') %>');
      };
      if (data.invoice_status) {
        if (data.invoice_status.id != '1' && !data.work_order_installation) {
          $("#ot-installation").removeClass("disabled");
        } else {
          $("#ot-installation").addClass("disabled");
        };
        if (data.invoice_status.id != '1') {
          $("#link-bill-span").hide();
        } else {
          $("#link-bill-span").show();
          $("#link-bill-span").text(data.invoice_status.code);
        };
      };
      // $("#bill-doc").removeClass("hide");
      // $("#unsubscribe-bill-doc").attr("href","/<%= params[:locale] %>/ag2_gest/<%= params[:locale] %>/bills/" + data.unsubscribe_bill.id);
      // $("#bailback-bill-doc").attr("href","/<%= params[:locale] %>/ag2_gest/<%= params[:locale] %>/bills/" + data.bailback_bill.id);
      // // $("#bill-doc").removeClass("hide");
    });


    $("#new-subscriber-cancellation").bind("ajax:success", function(xhr, data, status) {
      var currentStepWizard = $('a[href="#step-4"]'),
          nextStepWizard = $('a[href="#step-5"]');
      changeState(currentStepWizard,nextStepWizard);
      alert('<%= t('activerecord.attributes.contracting_request.alert_subscriber_id') %>');
    });

    $("#complete-add-concept").bind("ajax:success", function(xhr, data, status) {
      var currentStepWizard = $('a[href="#step-1"]'),
          nextStepWizard = $('a[href="#step-5"]');
      changeState(currentStepWizard,nextStepWizard);
      alert('<%= t('activerecord.attributes.contracting_request.alert_edit_subscriber_id') %>');
    });

    // ajax success for instalation_subscriber
    $("#form_new_subscriber").bind("ajax:success", function(xhr, data, status) {
      var currentStepWizard = $('a[href="#step-4"]'),
          nextStepWizard = $('a[href="#step-5"]');
      changeState(currentStepWizard,nextStepWizard);
      $("#new-subscriber").modal('hide');
      $("#link_subscriber").attr("href","/<%= params[:locale] %>/ag2_gest/<%= params[:locale] %>/subscribers/" + data.subscriber.id);
      $("#link_subscriber").text(data.subscriber.subscriber_code.substr(0, 4) + "-" + data.subscriber.subscriber_code.substr(4, 7));
      $("#date_subscriber").text(data.subscriber.created_at);
      $("#initial-reading").text(data.reading.reading_index);
      $("#installation-date").text(data.reading.reading_date);
      $("#contract_pdf").removeClass("hide");
      $("#contract_pdf").attr("href","/<%= params[:locale] %>/ag2_gest/<%= params[:locale] %>/contracting_requests/" + data.contracting_request.id + "/contract_pdf.pdf");
      $("#contract").text(data.water_supply_contract.contract_no.substr(0, 5) + '-' + data.water_supply_contract.contract_no.substr(6, 7) + '-' + data.water_supply_contract.contract_no.substr(8, 11) + '-' + data.water_supply_contract.contract_no.substr(12, 17));
      if (data.client_bank_accounts ) {
        $("#sepa_pdf").removeClass("hide");
        $("#sepa_pdf").attr("href","/<%= params[:locale] %>/ag2_gest/<%= params[:locale] %>/contracting_requests/" + data.contracting_request.id + "/sepa_pdf.pdf");
      };
    });

    // $("#instalation-subscriber").bind("ajax:success", function(xhr, data, status) {
    //
    //   var currentStepWizard = $('a[href="#step-4"]'),
    //       nextStepWizard = $('a[href="#step-5"]');
    //   changeState(currentStepWizard,nextStepWizard);
    //   // $("#link_subscriber").attr("href","/<%= params[:locale] %>/ag2_tech/<%= params[:locale] %>/subscriber/" + data.subscriber.id);
    //   // $("#link_subscriber").text(data.subscriber.subscriber_code.substr(0, 4) + "-" + data.work_order.subscriber_code.substr(4, 6);
    // });
    //
    // // ajax success for instalation_subscriber
    // $("#billing-form").bind("ajax:success", function(xhr, data, status) {
    //
    //   alert("Guardado con exito");
    // });
    //
    // $("#billing-form input").change(function() {
    //
    // });
    //
    // $("#submit-bill").click(function () {
    //
    //   $("#billing-form").submit();
    // });

    // allNextBtn.click(function(){
      // allNextBtn.attr('href', "/<%= params[:locale] %>/ag2_gest/<%= params[:locale] %>/contracting_requests/<%= @contracting_request.id %>/next_status")

    //   allNextBtn.bind("ajax:success", function(xhr, data, status) {
    //     var curStep = $(this).closest(".setup-content"),
    //         curStepBtn = curStep.attr("id"),
    //         currentStepWizard = $('div.setup-panel div a[href="#' + curStepBtn + '"]').parent().children("a"),
    //         nextStepWizard = $('div.setup-panel div a[href="#' + curStepBtn + '"]').parent().next().children("a"),
    //         curInputs = curStep.find("input[type='text'],input[type='url']");

    //     // Fill fields for client
    //     <% unless @contracting_request.client %>
    //       $("#link_client").attr("href","/<%= params[:locale] %>/ag2_gest/<%= params[:locale] %>/clients/" + data.client.id);
    //       $("#link_client").text(data.client.client_code.substr(0, 3) + "-" + data.client.client_code.substr(3));
    //     <% end %>

    //     // if (isValid)
    //     currentStepWizard
    //     currentStepWizard.siblings("p").removeClass("text-active")
    //     nextStepWizard.siblings("p").removeClass("text-inactive").addClass("text-active")
    //     nextStepWizard.removeAttr('disabled').trigger('click');
    // });

    // $(".newInvoice").click(function(){
    //     var curStep = $("#step-3"),
    //         curStepBtn = curStep.attr("id"),
    //         currentStepWizard = $('div.setup-panel div a[href="#' + curStepBtn + '"]').parent().children("a"),
    //         nextStepWizard = $('div.setup-panel div a[href="#' + curStepBtn + '"]').parent().next().children("a"),
    //         curInputs = curStep.find("input[type='text'],input[type='url']");

    //     $('#invoice_modal').modal('hide');
    //     currentStepWizard
    //     currentStepWizard.siblings("p").removeClass("text-active")
    //     nextStepWizard.siblings("p").removeClass("text-inactive").addClass("text-active")
    //     nextStepWizard.removeAttr('disabled').trigger('click');

    // });

    $('div.setup-panel div a.btn-primary').trigger('click');

    $('a[data-toggle="tab"]').on('click', function(){
      if ($(this).parent('li').hasClass('disabled')) {
        return false;
      };
    });
  });
</script>

<!-- wizard steps -->
<div class="row">
  <div class="stepwizard span12">
    <div class="stepwizard-row setup-panel">
      <div class="stepwizard-step">
          <a href="#step-1" type="button" class="btn btn-primary btn-circle" <%= 'disabled=disabled' unless @contracting_request.contracting_request_status_id == ContractingRequestStatus::INITIAL %>>1</a>
          <p class="text-inactive"><%= t('activerecord.attributes.contracting_request.initiated') %></p>
      </div>
      <%# if @contracting_request.contracting_request_type_id == 1 %>
        <div class="stepwizard-step">
            <a href="#step-2" type="button" class="btn btn-default btn-circle" <%= 'disabled=disabled' unless @contracting_request.contracting_request_status_id == ContractingRequestStatus::INSPECTION %>>2</a>
            <p class="text-inactive"><%= t('activerecord.attributes.contracting_request.inspection') %></p>
        </div>
      <%# end %>
      <div class="stepwizard-step">
          <a href="#step-3" type="button" class="btn btn-default btn-circle" <%= 'disabled=disabled' unless @contracting_request.contracting_request_status_id == ContractingRequestStatus::BILLING %>>3</a>
          <p class="text-inactive"><%= t('activerecord.attributes.contracting_request.biller') %></p>
      </div>
        <div class="stepwizard-step">
            <a href="#step-4" type="button" class="btn btn-default btn-circle" <%= 'disabled=disabled' unless @contracting_request.contracting_request_status_id == ContractingRequestStatus::INSTALLATION %>>4</a>
            <p class="text-inactive"><%= t('activerecord.attributes.contracting_request.subscriber') %></p>
        </div>
      <div class="stepwizard-step">
          <a href="#step-5" type="button" class="btn btn-default btn-circle" <%= 'disabled=disabled' unless @contracting_request.contracting_request_status_id == ContractingRequestStatus::COMPLETE %>>5</a>
          <p class="text-inactive"><%= t('activerecord.attributes.contracting_request.full') %></p>
      </div>
    </div>
  </div>
</div>

<!-- buttons -->
<div class="row">
  <!-- fixed buttons -->
  <div class="span4" >
    <%= link_to "<i class='icon-print icon-white'></i> #{t('activerecord.attributes.contracting_request.request')}".html_safe, contracting_request_pdf_contracting_request_path(@contracting_request, :format => :pdf), class: "btn btn-warning", target: "_blank"  %>

    <% if !@contracting_request.water_supply_contract.blank? && !@contracting_request.water_supply_contract.bailback_bill.blank? && !@contracting_request.water_supply_contract.bailback_bill.invoices.blank? && @contracting_request.contracting_request_status_id != ContractingRequestStatus::BILLING %>
      <%= link_to "<i class='icon-print icon-white'></i> #{t('activerecord.attributes.contracting_request.bailback')}".html_safe, biller_contract_pdf_bill_path(@contracting_request.water_supply_contract.bailback_bill_id, :format => :pdf), id: "bailback-bill-doc", class: "btn btn-warning #{'hide' unless @contracting_request.try(:water_supply_contract).try(:bailback_bill)}", target: "_blank"%>
    <% else %>
        <a target="_blank" id="bailback-bill-doc" type="button" class="btn btn-warning hide" href="#"><%= t('activerecord.attributes.contracting_request.bailback') %></a>
    <% end %>

    <% if !@contracting_request.water_supply_contract.blank? && !@contracting_request.water_supply_contract.unsubscribe_bill.blank? && !@contracting_request.water_supply_contract.unsubscribe_bill.invoices.blank? && @contracting_request.contracting_request_status_id != ContractingRequestStatus::BILLING %>
      <%= link_to "<i class='icon-print icon-white'></i> #{t('activerecord.attributes.contracting_request.invoice_service_c')}".html_safe, biller_pdf_bill_path(@contracting_request.water_supply_contract.unsubscribe_bill_id, :format => :pdf), id: "unsubscribe-bill-doc", class: "btn btn-warning #{'hide' unless @contracting_request.try(:water_supply_contract).try(:unsubscribe_bill)}", target: "_blank" %>
    <% else %>
        <a target="_blank" id="unsubscribe-bill-doc" type="button" class="btn btn-warning hide" href="#"><%= t('activerecord.attributes.contracting_request.invoice_service_c') %></a>
    <% end %>

    <% if !@contracting_request.water_supply_contract.blank? && !@contracting_request.water_supply_contract.bill.blank? && !@contracting_request.water_supply_contract.bill.invoices.blank? && @contracting_request.contracting_request_type_id != ContractingRequestType::CANCELLATION && @contracting_request.contracting_request_status_id != ContractingRequestStatus::BILLING %>
      <%= link_to "<i class='icon-print icon-white'></i> #{t('activerecord.attributes.contracting_request.invoice_contract_c')}".html_safe, biller_contract_pdf_bill_path(@contracting_request.water_supply_contract.bill_id, :format => :pdf), id: "bill-doc", class: "btn btn-warning #{'hide' unless @contracting_request.try(:water_supply_contract).try(:bill)}", target: "_blank" %>
    <% else %>
        <a target="_blank" id="bill-doc" type="button" class="btn btn-warning hide" href="#"><%= t('activerecord.attributes.contracting_request.invoice_contract_c') %></a>
    <% end %>
  </div>
  <!-- step buttons -->
  <form role="form" class="simple_form form-vertical span8">

    <!-- step 1 -->
    <div class="setup-content" id="step-1">
    <% if (@contracting_request.contracting_request_type_id == ContractingRequestType::ADD_CONCEPT) %>
      <a id="modal-data" href="#add-concept" data-toggle="modal" role="button" class="btn btn-primary"><%= t('activerecord.attributes.contracting_request.supply_data') %></a>
      <a id="complete-add-concept" class="btn btn-primary nextBtn" href="<%= params[:id] %>/complete_status" data-remote="true"><%= t('activerecord.attributes.contracting_request.edit_subscriber') %></a>
    <% else %>
      <!-- Hidden if not water_supply_contract, show when create -->
      <% if (@contracting_request.contracting_request_type_id == ContractingRequestType::CANCELLATION) or (@contracting_request.contracting_request_type_id == ContractingRequestType::CHANGE_OWNERSHIP) %>
        <a id="modal-data" href="#new-cancellation" data-toggle="modal" role="button" class="btn btn-primary"><%= t('activerecord.attributes.contracting_request.supply_data') %></a>
      <% else %>
        <a id="modal-data" href="#new-water-supply-contract" data-toggle="modal" role="button" class="btn btn-primary"><%= t('activerecord.attributes.contracting_request.supply_data') %></a>
      <% end %>

        <a id="initial-inspection" class="btn btn-primary nextBtn" href="<%= params[:id] %>/initial_inspection" data-remote="true" ><%= t('activerecord.attributes.contracting_request.inspection_order') %></a>

      <% if @contracting_request.contracting_request_type_id == ContractingRequestType::CANCELLATION or (@contracting_request.contracting_request_type_id == ContractingRequestType::CHANGE_OWNERSHIP) %>
        <a id="initial-billing-cancellation" data-disable-with="<%= t("activerecord.attributes.pre_reading.loading")%>" class="btn btn-primary nextBtn <%= 'disabled' if @contracting_request.water_supply_contract.nil? or @contracting_request.water_supply_contract.tariff_scheme.nil? or @contracting_request.water_supply_contract.tariff_scheme.tariffs.nil? or @contracting_request.water_supply_contract.tariff_scheme.tariffs_contract(@contracting_request.water_supply_contract.caliber_id).blank? or @contracting_request.water_supply_contract.installation_index.nil? %>" href="<%= params[:id] %>/initial_billing_cancellation" data-remote="true" ><%= t('activerecord.attributes.contracting_request.invoice_create') %></a>
      <% else %>
        <a id="initial-billing" data-disable-with="<%= t("activerecord.attributes.pre_reading.loading")%>" class="btn btn-primary nextBtn <%= 'disabled' if @contracting_request.water_supply_contract.nil? or @contracting_request.water_supply_contract.tariff_scheme.nil? or @contracting_request.water_supply_contract.tariff_scheme.tariffs.nil? or @contracting_request.water_supply_contract.tariff_scheme.tariffs_contract(@contracting_request.water_supply_contract.caliber_id).blank? %>" href="<%= params[:id] %>/initial_billing" data-remote="true" ><%= t('activerecord.attributes.contracting_request.invoice_create') %></a>
      <% end %>
    <% end %>
    </div>

    <!-- step 2 -->
    <div class="setup-content" id="step-2">
      <% if (@contracting_request.contracting_request_type_id == ContractingRequestType::CANCELLATION) or (@contracting_request.contracting_request_type_id == ContractingRequestType::CHANGE_OWNERSHIP) %>
        <a id="modal-data" href="#new-cancellation" data-toggle="modal" role="button" class="btn btn-primary"><%= t('activerecord.attributes.contracting_request.supply_data') %></a>

        <a id="ot-cancellation" class="btn btn-primary nextBtn <%= 'disabled' if !@work_order_retired.blank? %>" href="<%= params[:id] %>/ot_cancellation" data-remote="true" ><%= t('activerecord.attributes.contracting_request.cancellation_order') %></a>
        
        <a id="inspection-billing-cancellation" data-disable-with="<%= t("activerecord.attributes.pre_reading.loading")%>" class="btn btn-primary nextBtn <%= 'disabled' if @contracting_request.water_supply_contract.nil? or @contracting_request.water_supply_contract.tariff_scheme.nil? or @contracting_request.water_supply_contract.tariff_scheme.tariffs.nil? or @contracting_request.water_supply_contract.tariff_scheme.tariffs_contract(@contracting_request.water_supply_contract.caliber_id).blank?  or @contracting_request.water_supply_contract.installation_index.nil? %>" href="<%= params[:id] %>/inspection_billing_cancellation" data-remote="true" ><%= t('activerecord.attributes.contracting_request.invoice_create') %></a>
      <% else %>
        <a id="modal-data" href="#new-water-supply-contract" data-toggle="modal" role="button" class="btn btn-primary"><%= t('activerecord.attributes.contracting_request.supply_data') %></a>
        <a id="inspection-billing" data-disable-with="<%= t("activerecord.attributes.pre_reading.loading")%>" class="btn btn-primary nextBtn <%= 'disabled' if @contracting_request.water_supply_contract.nil? or @contracting_request.water_supply_contract.tariff_scheme.nil? or @contracting_request.water_supply_contract.tariff_scheme.tariffs.nil? or @contracting_request.water_supply_contract.tariff_scheme.tariffs_contract(@contracting_request.water_supply_contract.caliber_id).blank? %>" href="<%= params[:id] %>/inspection_billing" data-remote="true" ><%= t('activerecord.attributes.contracting_request.invoice_create') %></a>
      <% end %>

    </div>

    <!-- step 3 -->
    <div class="setup-content" id="step-3">
      <% if @contracting_request.contracting_request_type_id == ContractingRequestType::CANCELLATION or @contracting_request.contracting_request_type_id == ContractingRequestType::CHANGE_OWNERSHIP %>
      <% if !@contracting_request.water_supply_contract.blank? %>
        <a id="billing-instalation-cancellation" href="<%= params[:id] %>/billing_instalation_cancellation" data-disable-with="<%= t("activerecord.attributes.pre_reading.loading")%>" class="btn btn-primary nextBtn" data-remote="true"><%= t('activerecord.attributes.contracting_request.invoice_confirm') %></a>

        <% if !@contracting_request.water_supply_contract.bailback_bill.blank? %>
          <a id="edit-bailback" href="#billing-bailback-modal-cancellation" data-toggle="modal" role="button" class="btn btn-primary"><%= t('activerecord.attributes.contracting_request.invoice_c') + t('activerecord.attributes.contracting_request.bailback')%></a>
        <% else %>
          <a id="edit-bailback" href="#billing-bailback-modal-cancellation" data-toggle="modal" role="button" class="btn btn-primary hide"><%= t('activerecord.attributes.contracting_request.invoice_c') + t('activerecord.attributes.contracting_request.bailback')%></a>
        <% end %>

        <% if !@contracting_request.water_supply_contract.unsubscribe_bill.blank? %>
          <a id="edit-unsubscribe" href="#billing-unsubscribe-modal-cancellation" data-toggle="modal" role="button" class="btn btn-primary"><%= t('activerecord.attributes.contracting_request.invoice_c') + t('activerecord.attributes.contracting_request.cancellation_contract')%></a>
        <% else %>
          <a id="edit-unsubscribe" href="#billing-unsubscribe-modal-cancellation" data-toggle="modal" role="button" class="btn btn-primary hide"><%= t('activerecord.attributes.contracting_request.invoice_c') + t('activerecord.attributes.contracting_request.cancellation_contract')%></a>
        <% end %>

        <% if !@contracting_request.water_supply_contract.bill.blank? %>
          <a id="edit-bill" href="#billing-modal" data-toggle="modal" role="button" class="btn btn-primary"><%= t('activerecord.attributes.contracting_request.invoice_c')  + t('activerecord.attributes.contracting_request.new_contract') %></a>
        <% else %>
          <a id="edit-bill" href="#billing-modal" data-toggle="modal" role="button" class="btn btn-primary hide"><%= t('activerecord.attributes.contracting_request.invoice_c')  + t('activerecord.attributes.contracting_request.new_contract') %></a>
        <% end %>
      <% end %>
      <% else %>
        <a id="billing-instalation" href="<%= params[:id] %>/billing_instalation" data-disable-with="<%= t("activerecord.attributes.pre_reading.loading")%>" class="btn btn-primary nextBtn" data-remote="true"><%= t('activerecord.attributes.contracting_request.invoice_confirm') %></a>

        <a href="#billing-modal" data-toggle="modal" role="button" class="btn btn-primary"><%= t('activerecord.attributes.contracting_request.invoice_edit') %></a>
      <% end %>
    </div>

    <!-- step 4 -->
    <div class="setup-content" id="step-4">
      <% if @contracting_request.contracting_request_type_id == ContractingRequestType::CANCELLATION %>
        <% if @contracting_request.old_subscriber.current_debt != '0' %>
          <a id="new-subscriber-cancellation" data-confirm='<%= t('activerecord.attributes.contracting_request.alert_debt') + number_with_precision(@contracting_request.old_subscriber.current_debt, precision: 2, delimiter: I18n.locale == :es ? "." : ",") + t('activerecord.attributes.contracting_request.alert_debt_2')%>' class="btn btn-primary nextBtn" href="<%= params[:id] %>/new_subscriber_cancellation" data-remote="true"><%= t('activerecord.attributes.contracting_request.cancellation_subscriber') %></a>
        <% else %>
          <a id="new-subscriber-cancellation" class="btn btn-primary nextBtn" href="<%= params[:id] %>/new_subscriber_cancellation" data-remote="true"><%= t('activerecord.attributes.contracting_request.cancellation_subscriber') %></a>
        <% end %>
      <% else %>
        <% if !@contracting_request.water_supply_contract.blank? %>
          <% if !@contracting_request.water_supply_contract.bill.blank?%>
          <a id="ot-installation" class="btn btn-primary nextBtn <%= 'disabled' if @contracting_request.water_supply_contract.bill.invoices.first.invoice_status_id == InvoiceStatus::PENDING or !@contracting_request.water_supply_contract.work_order.blank? %>" href="<%= params[:id] %>/ot_installation" data-remote="true" ><%= t('activerecord.attributes.contracting_request.inspection_order_installation') %></a>
          <% else %>
            <a id="ot-installation" class="btn btn-primary nextBtn <%= 'disabled' if !@contracting_request.water_supply_contract.work_order.blank? %>" href="<%= params[:id] %>/ot_installation" data-remote="true" ><%= t('activerecord.attributes.contracting_request.inspection_order_installation') %></a>
          <% end %>
          <% if @contracting_request.water_supply_contract.work_order.blank?%>
            <a href="#new-subscriber" id="new-subscriber-installation" data-toggle="modal" role="button" class="btn btn-primary <%= 'disabled' if @contracting_request.water_supply_contract.work_order_id.blank? %>" data-remote="true"><%= t('activerecord.attributes.contracting_request.data_subscriber') %></a>
          <% else %>
            <!-- <a href="#new-subscriber" id="new-subscriber-installation" data-toggle="modal" role="button" class="btn btn-primary <#%= 'disabled' if @contracting_request.water_supply_contract.work_order_id.blank? or @contracting_request.water_supply_contract.work_order.work_order_status_id != WorkOrderStatus::COMPLETED and @contracting_request.water_supply_contract.work_order.work_order_status_id != WorkOrderStatus::CLOSED %>" data-remote="true"><#%= t('activerecord.attributes.contracting_request.data_subscriber') %></a> -->
            <a href="#new-subscriber" id="new-subscriber-installation" data-toggle="modal" role="button" class="btn btn-primary <%= 'disabled' if @contracting_request.water_supply_contract.work_order_id.blank? %>" data-remote="true"><%= t('activerecord.attributes.contracting_request.data_subscriber') %></a>
          <% end %>
        <% end %>
      <% end %>
    </div>

    <!-- step 5 -->
    <div class="setup-content" id="step-5">
    <% if @contracting_request.contracting_request_type_id != ContractingRequestType::CANCELLATION && !@contracting_request.subscriber.blank? %>
      <%= link_to "<i class='icon-print icon-white'></i> #{t('activerecord.attributes.contracting_request.show_contract')}".html_safe, contract_pdf_contracting_request_path(@contracting_request, :format => :pdf), id: "contract_pdf",class: "btn btn-warning", target: "_blank"  %>
      <%= link_to "<i class='icon-print icon-white'></i> #{t('activerecord.attributes.water_supply_contract.pay_sepa_order_c')}".html_safe, sepa_pdf_contracting_request_path(@contracting_request, :format => :pdf), id: "sepa_pdf",class: "btn btn-warning", target: "_blank"  unless @contracting_request.client.client_bank_accounts.active.blank?  %>
    <% else %>
        <a target="_blank" id="contract_pdf" type="button" class="btn btn-warning hide" href="#"><%= t('activerecord.attributes.contracting_request.show_contract') %></a>
        <a target="_blank" id="sepa_pdf" type="button" class="btn btn-warning hide" href="#"><%= t('activerecord.attributes.water_supply_contract.pay_sepa_order_c') %></a>

    <% end %>
    </div>
  </form>
  <a id="refresh-status" class="step-refresh icon-refresh-link" href="<%= params[:id] %>/refresh_status" data-remote="true" ><i class="icon-refresh"></i></a>
</div>

<div class="row-fluid">
  <div class="span4">
    <h4><%= t('activerecord.attributes.contracting_request.info_domicile') %></h4>
    <table class="table table-center table-condensed">
      <tbody>
        <tr>
          <td><b><%= t('activerecord.attributes.water_supply_contract.contract_term') %></b></td>
          <td id="water_supply_contract_contract_term"><%= @water_supply_contract.contract_term.capitalize unless @water_supply_contract.contract_term.blank? %></td>
        </tr>
        <tr>
          <td><b><%= t('activerecord.attributes.contracting_request.cadastral_reference') %></b></td>
          <td id="water_supply_contract_cadastral_reference"><%= @water_supply_contract.cadastral_reference %></td>
        </tr>
        <tr>
          <td><b><%= t('activerecord.attributes.contracting_request.pub_record') %></b></td>
          <td id="water_supply_contract_pub_record"><%= @water_supply_contract.pub_record %></td>
        </tr>
        <tr>
          <td><b><%= t('activerecord.attributes.contracting_request.gis_id') %></b></td>
          <td id="water_supply_contract_gis_id"><%= @water_supply_contract.gis_id %></td>
        </tr>
        <tr>
          <td><b><%= t('activerecord.attributes.contracting_request.endowments') %></b></td>
          <td id="water_supply_contract_endowments"><%= @water_supply_contract.endowments %></td>
        </tr>
        <tr>
          <td><b><%= t('activerecord.attributes.contracting_request.inhabitants') %></b></td>
          <td id="water_supply_contract_inhabitants"><%= @water_supply_contract.inhabitants %></td>
        </tr>
        <tr>
          <td><b><%= t('activerecord.attributes.water_supply_contract.inhabitants_ending_at') %></b></td>
          <td id="water_supply_contract_inhabitants_ending_at"><%=l @water_supply_contract.try(:inhabitants_ending_at), format: :long if @water_supply_contract.try(:inhabitants_ending_at) %></td>
        </tr>
        <tr>
          <td><b><%= t('activerecord.attributes.water_supply_contract.min_pressure') %></b></td>
          <td id="water_supply_contract_min_pressure"><%= @water_supply_contract.min_pressure %></td>
        </tr>
        <tr>
          <td><b><%= t('activerecord.attributes.water_supply_contract.max_pressure') %></b></td>
          <td id="water_supply_contract_max_pressure"><%= @water_supply_contract.max_pressure %></td>
        </tr>
        <% if @contracting_request.old_subscriber %>
          <tr>
            <td><b><%= t('ag2_gest.contracting_requests.show.old_subscriber') %></b></td>
            <td><%= link_to @contracting_request.old_subscriber.to_label, subscriber_path(@contracting_request.old_subscriber) %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="span4">
    <h4><%= t('activerecord.attributes.contracting_request.info_tariff') %></h4>
    <table class="table table-center table-condensed">
      <tbody>
        <tr>
          <td><b><%= t('activerecord.attributes.contracting_request.use') %></b></td>
          <td id="use"><%= @water_supply_contract.try(:use).try(:name) %></td>
        </tr>
        <tr>
          <td><b><%= t('activerecord.attributes.contracting_request.tariff_scheme') %></b></td>
          <td>
            <% if @water_supply_contract.tariff_scheme %>
              <%= link_to @water_supply_contract.tariff_scheme.name, tariff_scheme_path(@water_supply_contract.tariff_scheme) unless @water_supply_contract.tariff_scheme.blank? %>
            <% else %>
              <a id="tariff_scheme" href="#"></a>
            <% end %>
          </td>
        </tr>
        <tr>
          <td><b><%= t('activerecord.attributes.contracting_request.tariff_type') %></b></td>
          <td id="tariff_type"><%= @tariff_type %></td>
        </tr>
        <!-- <tr>
          <td><b>Importe fijo contratacin</b></td>
          <td id="tariff_fixed_fee"><%#= @water_supply_contract.tariff.fixed_fee.to_s + " " if @water_supply_contract.tariff %></td>
        </tr> -->
        <!-- <tr>
          <td><b>Frec. Facturacion</b></td>
          <td id="billing_frequency"><%= @water_supply_contract.try(:tariff_scheme).try(:tariff_type).try(:name) %></td>
        </tr> -->
      </tbody>
    </table>
    <h4>PUNTO DE SERVICIO</h4>
    <table class="table table-center table-condensed">
      <tbody>
        <tr>
          <td><b>Referencia</b></td>
          <td><%= link_to @contracting_request.service_point.full_code, ag2_gest.service_point_path(@contracting_request.service_point) unless @contracting_request.service_point.blank? %></td>
        </tr>
        <tr>
          <td><b>Direccin</b></td>
          <td><%= @contracting_request.service_point.to_full_label unless @contracting_request.service_point.blank? %></td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="span4">
    <h4><%= t('activerecord.attributes.contracting_request.mesaure_device') %></h4>
    <table class="table table-center table-condensed">
      <tbody>
        <tr>
          <td><b><%= t('activerecord.attributes.contracting_request.code_meter') %></b></td>
          <td id="meter_code"><%= link_to @water_supply_contract.try(:meter).try(:to_label), meter_path(@water_supply_contract.try(:meter)) if @water_supply_contract.meter %></td>
          <td><b><%= t('activerecord.attributes.contracting_request.caliber') %></b></td>
          <td id="caliber"><%= link_to @water_supply_contract.try(:caliber).try(:caliber), caliber_path(@water_supply_contract.try(:caliber)) if @water_supply_contract.caliber %></td>
        </tr>
        <tr>
          <td><b><%= t('activerecord.attributes.contracting_request.brand_model') %></b></td>
          <td colspan="3"><small id="meter_model" ><%= "#{@water_supply_contract.try(:meter).try(:meter_model).try(:meter_brand).try(:brand)}/#{@water_supply_contract.try(:meter).try(:meter_model).try(:model)}" %></small></td>
        </tr>
        <tr>
          <td><b><%= t('activerecord.attributes.contracting_request.initial_reading') %></b></td>
          <% if (@contracting_request.contracting_request_type_id == ContractingRequestType::CANCELLATION) %>
            <td colspan="3" id="initial-reading"><%= @contracting_request.try(:old_subscriber).try(:meter_details).try(:last).try(:installation_reading) %></td>
          <% else %>
            <td colspan="3" id="initial-reading"><%= @contracting_request.try(:subscriber).try(:meter_details).try(:last).try(:installation_reading) %></td>
          <% end %>
        </tr>
        <tr>
          <td><b><%= t('activerecord.attributes.contracting_request.installation_date') %></b></td>
          <% if (@contracting_request.contracting_request_type_id == ContractingRequestType::CANCELLATION) %>
            <td colspan="3" id="installation-date"><%=l @contracting_request.try(:old_subscriber).try(:meter_details).try(:last).try(:installation_date), format: :long if @contracting_request.try(:old_subscriber) %></td>
          <% else %>
            <td colspan="3" id="installation-date"><%=l @contracting_request.try(:subscriber).try(:meter_details).try(:last).try(:installation_date), format: :long if @contracting_request.try(:subscriber) %></td>
          <% end %>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<div class="row-fluid">

  <div class="span4">
    <h4><%= t('activerecord.attributes.contracting_request.work_order') %></h4>
    <table class="table table-center table-condensed">
      <tbody>
        <tr>
          <td><b><%= t('activerecord.attributes.contracting_request.inspection_order') %></b></td>
          <td>
            <% if @contracting_request.work_order %>
              <%= link_to @contracting_request.work_order.full_no, ag2_tech.work_order_path(@contracting_request.work_order), id: "link_work_order_inspection" %>
            <% else %>
              <a id="link_work_order_inspection" href="#"></a>
            <% end %>
          </td>
        </tr>
        <tr>
          <td><b><%= t('activerecord.attributes.contracting_request.state_work_order') %></b></td>
          <% if @contracting_request.work_order %>
            <td id="status_work_order_inspection"><%= @contracting_request.work_order.work_order_status.name %></td>
          <% else %>
            <td id="status_work_order_inspection"></td>
          <% end %>
          </td>
        </tr>

        <% if (@contracting_request.contracting_request_type_id == ContractingRequestType::CANCELLATION) or (@contracting_request.contracting_request_type_id == ContractingRequestType::CHANGE_OWNERSHIP) %>
          <tr>
            <td><b><%= t('activerecord.attributes.contracting_request.cancellation_order') %></b></td>
            <td>
              <% if @work_order_retired %>
                <%= link_to @work_order_retired.full_no, ag2_tech.work_order_path(@work_order_retired), id: "link_work_order_cancellation" %>
              <% else %>
                <a id="link_work_order_cancellation" href="#"></a>
              <% end %>
            </td>
          </tr>
          <tr>
            <td><b><%= t('activerecord.attributes.contracting_request.state_work_order') %></b></td>
            <% if @work_order_retired %>
              <td id="status_work_order_cancellation"><%= @work_order_retired.work_order_status.name %></td>
            <% else %>
              <td id="status_work_order_cancellation"></td>
            <% end %>
            </td>
          </tr>
      <% end %>
      <% if (@contracting_request.contracting_request_type_id == ContractingRequestType::SUPPLY) or (@contracting_request.contracting_request_type_id == ContractingRequestType::CHANGE_OWNERSHIP) %>
          <tr>
            <td><b><%= t('activerecord.attributes.contracting_request.inspection_order_installation') %></b></td>
            <td>
              <% if @contracting_request.water_supply_contract && @contracting_request.water_supply_contract.work_order %>
                <%= link_to @contracting_request.water_supply_contract.work_order.full_no, ag2_tech.work_order_path(@contracting_request.water_supply_contract.work_order), id: "link_work_order_installation" %>
              <% else %>
                <a id="link_work_order_installation" href="#"></a>
              <% end %>
            </td>
          </tr>
          <tr>
            <td><b><%= t('activerecord.attributes.contracting_request.state_work_order') %></b></td>
            <% if @contracting_request.water_supply_contract && @contracting_request.water_supply_contract.work_order %>
              <td id="status_work_order_installation"><%= @contracting_request.water_supply_contract.work_order.work_order_status.name %></td>
            <% else %>
              <td id="status_work_order_installation"></td>
            <% end %>
            </td>
          </tr>
      <% end %>


        <!-- <tr>
          <td><b>Orden de instalacin</b></td>
          <%# if @contracting_request.water_supply_contract.try(:work_order) %>
            <td><%#= link_to @contracting_request.water_supply_contract.work_order.full_no, ag2_tech.work_order_path(@contracting_request.water_supply_contract.work_order) %></td>
          <%# else %>
            <td><a id="link_work_order_instalation" href="#"></a></td>
          <%# end %>
        </tr>
        <tr>
          <td><b>Estado de instalacion</b></td>
          <%# if @contracting_request.water_supply_contract.try(:work_order) %>
            <td><%#= @contracting_request.water_supply_contract.work_order.work_order_status.name %></td>
          <%# else %>
            <td id="status_work_order_instalation"></td>
          <%# end %>
          </td>
        </tr> -->
      </tbody>
    </table>
  </div>


  <div class="span4">
    <h4><%= t('activerecord.attributes.contracting_request.subscriber_client') %></h4>
    <table class="table table-center table-condensed">
      <tbody>
        <tr>
          <td><b><%= t('activerecord.attributes.contracting_request.client') %></b></td>
          <td>
            <% if @contracting_request.client %>
              <%= link_to @contracting_request.client.full_code, client_path(@contracting_request.client) %>
            <% else %>
              <a id="link_client" href="#"></a>
            <% end %>
          </td>
        </tr>
        <tr>
          <td><b><%= t('activerecord.attributes.contracting_request.starting_at') %></b></td>
          <td><%= l( @contracting_request.client.created_at, format: :long) if @contracting_request.client %></td>
        </tr>
        <tr>
          <td><b><%= t('activerecord.attributes.contracting_request.number_subscriber') %></b></td>
          <td>
            <% if @contracting_request.subscriber %>
              <%= link_to @contracting_request.subscriber.full_code, subscriber_path(@contracting_request.subscriber) %>
            <% else %>
              <a id="link_subscriber" href="#"></a>
            <% end %>
          </td>
        </tr>
        <tr>
          <td><b><%= t('activerecord.attributes.contracting_request.starting_at') %></b></td>
            <td id="date_subscriber"><%=l(@contracting_request.subscriber.created_at, format: :long) if @contracting_request.subscriber %></td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="span4">
    <h4><%= t('activerecord.attributes.contracting_request.bill').upcase %></h4>
    <table class="table table-center table-condensed">
      <tbody>
        <tr>
        <% if (@contracting_request.contracting_request_type_id != ContractingRequestType::CANCELLATION) %>
          <td><b><%= t('activerecord.attributes.contracting_request.invoice_contract_c') %></b></td>
          <td>
            <% if @contracting_request.try(:water_supply_contract).try(:bill) && @contracting_request.contracting_request_status_id != ContractingRequestStatus::BILLING   %>
              <% if @contracting_request.try(:water_supply_contract).try(:bill).try(:invoices).first.try(:invoice_status_id) == InvoiceStatus::PENDING %>
                <%= link_to @contracting_request.water_supply_contract.bill.invoice_based_old_no_real_no, client_payment_url(:id => "",:No => @contracting_request.water_supply_contract.bill.raw_invoice_based_no), id: "link-bill" %><span class="yellow" id="link-bill-span"><%= " " + @contracting_request.water_supply_contract.bill.invoices.first.invoice_status.code unless @contracting_request.water_supply_contract.bill.invoices.first.invoice_status.blank? %></span>
              <% elsif @contracting_request.try(:water_supply_contract).try(:bill).try(:invoices).first.try(:invoice_status_id) != InvoiceStatus::PENDING %>
                <%= @contracting_request.water_supply_contract.bill.invoice_based_old_no_real_no %><span class="yellow" id="link-bill-span"><%= " " + @contracting_request.water_supply_contract.bill.invoices.first.invoice_status.code unless @contracting_request.water_supply_contract.bill.invoices.first.invoice_status.blank? %></span>
              <% end %>
            <% else %>
              <a id="link-bill" href="#"></a><span class="yellow hide" id="link-bill-span"><%= " P" %></span>
            <% end %>
          </td>
        <% end %>
          <% if (@contracting_request.contracting_request_type_id == ContractingRequestType::CANCELLATION) or (@contracting_request.contracting_request_type_id == ContractingRequestType::CHANGE_OWNERSHIP) %>
            <tr>
              <td><b><%= t('activerecord.attributes.contracting_request.bailback') %></b></td>
              <td>
              <% if @contracting_request.try(:water_supply_contract).try(:bailback_bill) && @contracting_request.contracting_request_status_id != ContractingRequestStatus::BILLING  %>
                <% if @contracting_request.try(:water_supply_contract).try(:bbailback_billill).try(:invoices).first.try(:invoice_status_id) == InvoiceStatus::PENDING %>
                  <%= link_to @contracting_request.water_supply_contract.bailback_bill.invoice_based_old_no_real_no, client_payment_path(:id => "",:No => @contracting_request.water_supply_contract.bailback_bill.raw_invoice_based_no)  %>
                <% elsif @contracting_request.try(:water_supply_contract).try(:bailback_bill).try(:invoices).first.try(:invoice_status_id) != InvoiceStatus::PENDING %>
                  <%= @contracting_request.water_supply_contract.bailback_bill.invoice_based_old_no_real_no %>
                <% end %>
              <% else %>
                <a id="link-bailback-bill" href="#"></a>
              <% end %>
              </td>
            </tr>
            <tr>
              <td><b><%= t('activerecord.attributes.contracting_request.invoice_service') %></b></td>
              <td>
              <% if @contracting_request.try(:water_supply_contract).try(:unsubscribe_bill) && @contracting_request.contracting_request_status_id != ContractingRequestStatus::BILLING   %>
                <% if @contracting_request.try(:water_supply_contract).try(:unsubscribe_bill).try(:invoices).first.try(:invoice_status_id) == InvoiceStatus::PENDING %>
                  <%= link_to @contracting_request.water_supply_contract.unsubscribe_bill.invoice_based_old_no_real_no, client_payment_path(:id => "",:No => @contracting_request.water_supply_contract.unsubscribe_bill.raw_invoice_based_no), id: "link-unsubscribe-bill" %><span class="yellow" id="link-unsubscribe-bill-span"><%= " " + @contracting_request.water_supply_contract.unsubscribe_bill.invoices.first.invoice_status.code unless @contracting_request.water_supply_contract.unsubscribe_bill.invoices.first.invoice_status.blank? %></span>
                <% elsif @contracting_request.try(:water_supply_contract).try(:unsubscribe_bill).try(:invoices).first.try(:invoice_status_id) != InvoiceStatus::PENDING %>
                  <%= @contracting_request.water_supply_contract.unsubscribe_bill.invoice_based_old_no_real_no %><span class="yellow" id="link-unsubscribe-bill-span"><%= " " + @contracting_request.water_supply_contract.unsubscribe_bill.invoices.first.invoice_status.code unless @contracting_request.water_supply_contract.unsubscribe_bill.invoices.first.invoice_status.blank? %></span>
                <% end %>
              <% else %>
                <a id="link-unsubscribe-bill" href="#"></a><span class="yellow hide" id="link-unsubscribe-bill-span"><%= " P" %></span>
              <% end %>
              </td>
            </tr>
            <% end %>
        </tr>
        <tr>

        </tr>
      </tbody>
    </table>
    <h4><%= t('activerecord.attributes.contracting_request.remark').upcase %></h4>
    <table class="table table-center table-condensed">
      <tbody>
        <tr>
          <td colspan="2" id="water_supply_contract_remarks"><%= @water_supply_contract.remarks %></td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
<% if !@water_supply_contract.tariffs.blank? %>
  <div class="row-fluid">
    <div class="span12">
      <h4><%= t('activerecord.attributes.water_supply_contract.tariff_association') %></h4>
      <table class="table table-condensed table-striped">
        <thead>
          <tr>
            <!-- <th></th> -->
            <th><%= t('activerecord.attributes.tariff_scheme.billable_concept') %></th>
            <th><%= t('activerecord.attributes.tariff_scheme.tariff_type_id') %></th>
            <th><%= t('activerecord.attributes.tariff.billing_frequency_id') %>:</th>
            <th><%= t('activerecord.attributes.tariff.starting_at') %></th>
            <th><%= t('activerecord.attributes.tariff.ending_at') %></th>
            <th></th>
          </tr>
        </thead>
        <tbody>

          <% SubscriberTariff.availables_to_subscriber(@subscriber.id).each do |t| %>
              <tr>
                  <td class="billable_concept"><%= t.tariff.try(:billable_concept).try(:name) %></td>
                  <td class="tariff_type"><%= t.tariff.try(:tariff_type).try(:name) %></td>
                  <td class="billing_frequency"><%= t.tariff.try(:billing_frequency).try(:to_label) %></td>
                  <td class="starting_at"><%=l t.try(:starting_at) unless t.try(:starting_at).blank? %></td>
                  <td class="ending_at"><%=l t.try(:ending_at) unless t.try(:ending_at).blank? %></td>
                  <td><%= render :partial => '/layouts/crud/read', :locals => { :model => Tariff, :path => tariff_path(t.tariff) } %></td>
              </tr>
            <%# end %>
          <% end %>

        </tbody>
      </table>

    </div>
  </div>
<% end %>

<%= render '/ag2_gest/contracting_requests/modals/new_water_supply_contract' %>

<%= render '/ag2_gest/contracting_requests/modals/new_cancellation' %>

<%= render '/ag2_gest/contracting_requests/modals/add_concept' %>

<%= render '/ag2_gest/contracting_requests/modals/new_bill' %>

<%= render '/ag2_gest/contracting_requests/modals/bailback_bill_cancellation' %>

<%= render '/ag2_gest/contracting_requests/modals/unsubscribe_bill_cancellation' %>

<%= render '/ag2_gest/contracting_requests/modals/new_bill_cancellation' %>

<%= render '/ag2_gest/contracting_requests/modals/new_subscriber' %>
