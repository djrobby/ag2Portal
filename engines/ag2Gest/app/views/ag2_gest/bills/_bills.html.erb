<script>
  $(document).ready(function() {
    $("#div_table #pages a").on("click", function() {
      $.getScript(this.href);
      return false;
    });
  });
</script>
<div class="row">
  <div class="span3" align="center"><h5><b><%= I18n.t("ag2_gest.bills.index.total_subscribers") %>:</b> <%= @bills.count %></h5></div>
  <div class="span4"><h5><b><%= I18n.t("ag2_gest.bills.index.total_consumptions") %>:</b> <%= @bills.map(&:reading_2).flatten.compact.sum{|r| r.consumption } %> m<sup>3</sup></h5></div>
  <div class="span4" align="right"><h5><b><%= I18n.t("ag2_gest.bills.index.total_bills") %>:</b> <%= number_to_currency(@bills.sum{|b| b.total}, unit: "€", precision: 4) %></h5></div>
</div>
<br/>

<div class="row">
  <div class="span1"></div> <!-- Space for icon-plus -->
  <div class="span1">
    <b>Id</b>
  </div>
  <div class="span4 text-center">
    <b>Abonado</b>
  </div>
  <div class="span1">
    <b>Contador</b>
  </div>
  <div class="span1">
    <b>Consumo</b>
  </div>
  <div class="span1">
    <b>Total</b>
  </div>
  <div class="span1">
    <b>¿Facturado?</b>
  </div>
  <div class="span1">
  </div>
</div>
<% @bills.each do |b| %>

<!-- RENDER2 FACTURA DE SUMINISTRO-->
<div class="accordion">
  <div class="accordion-group">
    <div class="accordion-heading row">
      <div class="span1">
        <a class="accor accordion-toggle collapsed" data-toggle="collapse" data-parent="#accordion2" href="#collapse-<%= b.id %>"><i class='icon-plus'></i></a>
      </div>
      <div class="span1 soft-padding">
        <%= b.try(:id) %>
      </div>
      <div class="span4 soft-padding">
        <%= link_to b.subscriber.to_label, subscriber_path(b.subscriber) %>
      </div>
      <div class="span1 soft-padding">
        <%= link_to b.subscriber.try(:meter).try(:meter_code), meter_path(b.subscriber.meter) %>
      </div>
      <div class="span1 soft-padding text-center">
        <%= b.reading.try(:consumption) || 0 %>
      </div>
      <div class="span1 soft-padding text-center">
        <%= b.total %>
      </div>
      <div class="span1 text-center">
        <% if b.bill %> <i class="icon-thumbs-up"></i> <% else %> <i class="icon-thumbs-down"></i> <% end %>
      </div>
      <div class="span1 soft-padding pull-right">
        <%= link_to bill_path(b, bills: b.pre_group_no), class: "btn btn-mini", method: :delete, data: { confirm: 'Are you sure?' } do %>
          <i class="icon-trash"></i>
        <% end %>
      </div>
    </div>
    <div id="collapse-<%= b.id %>" class="accordion-body collapse">
      <div class="accordion-inner">
        <% b.pre_invoices.each do |invoice| %>
          <div><small><%= t("activerecord.attributes.contracting_request.invoice_number") %>: <%= invoice.try(:invoice_no) %></small></div>
          <div><small><%= invoice.try(:biller).try(:name) %> | <%= t("activerecord.attributes.contracting_request.fiscal_id") %> <%= invoice.try(:biller).try(:fiscal_id) %></small></div>
          <table class="table">
            <tr>
              <th><%= t("activerecord.attributes.contracting_request.code") %></th>
              <th><%= t("activerecord.attributes.contracting_request.subcode") %></th>
              <th><%= t("activerecord.attributes.contracting_request.quantity") %></th>
              <th><%= t("activerecord.attributes.contracting_request.price") %></th>
              <th><%= t("activerecord.attributes.contracting_request.amount") %></th>
              <th><%= t("activerecord.attributes.contracting_request.tax") %></th>
              <th><%= t("activerecord.attributes.contracting_request.discount") %></th>
              <th><%= t("activerecord.attributes.contracting_request.discount_pct") %></th>
              <th><%= t("activerecord.attributes.contracting_request.total") %></th>
            </tr>
            <% invoice.pre_invoice_items.each do |item| %>
              <tr>
                <td><%= item.code %></td>
                <td><%= item.subcode %></td>
                <td><%= item.quantity %></td>
                <td><%= item.price %></td>
                <td><%= item.amount %></td>
                <td><%= item.tax_type.try(:tax) %></td>
                <td><%= item.discount %></td>
                <td><%= item.discount_pct %></td>
                <td><%= item.total %></td>
              </tr>
            <% end %>
            <tr class="subtotal">
              <td colspan="7" class="no-boder"></td>
              <td class="black-border"><b><%= t('activerecord.attributes.subscriber.subtotal').upcase %></b></td>
              <td class="black-border"><%= invoice.subtotal %></td>
            </tr>
            <% invoice.tax_breakdown.each do |tax| %>
              <tr>
                <td colspan="5" class="no-boder"></td>
                <td class="no-boder"><b>Base imponible:</b> <%= tax[1] %></td>
                <td class="no-boder"><%= "#{pluralize(tax[3], 'artículo')}"  %></td>
                <td><b><%= " #{t('activerecord.attributes.subscriber.vat')} (#{tax[0]}%)" %></b></td>
                <td><%= tax[2] %></td>
              </tr>
            <% end %>
            <tr>
              <td colspan="7" class="black-border"></td>
              <td class="black-border"><b><%= t('activerecord.attributes.subscriber.total').upcase %></b></td>
              <td class="black-border"><%= invoice.total %></td>
            </tr>
        <% end %>
        </table>
      </div>
    </div>
  </div>
  <% end %>
</div>

<%= render :partial => '/layouts/pagination', :locals => { :ivar => @contracting_requests } %>

<br/>
<a href="#confirm-bills" role="button" class="btn btn-primary" data-toggle="modal">Confirmar facturas</a>
<br/>
<br/>
<%= link_to t("ag2_gest.bills.index.back_to_pre_index"), ag2_gest.pre_index_bills_path %>


<!-- Modal -->
<div id="confirm-bills" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="ConfirmarBills" aria-hidden="true">
  <%= simple_form_for :pre_bill, url: confirm_bills_path, method: :get do |f| %>
    <%= f.input :ids, :as => :hidden, :input_html => { :value =>  params[:bills] } %>
    <div class="modal-header">
      <h4>Confirmar facturas</h4>
    </div>
    <div class="modal-body">
      <%= f.input :confirmation_date, required: true, label: I18n.t("ag2_gest.bills.index.confirmation_date"), :label_html => { :class => 'form-label' }, :input_html => {class: "string required mid-text-field date_picker", value: Date.today} %>
      <%= f.input :invoice_date, required: false, label: I18n.t("ag2_gest.bills.index.invoice_date"), :label_html => { :class => 'form-label' }, :input_html => {class: "mid-text-field date_picker", value: @bills.first.pre_invoices.first.try(:billing_period).try(:billing_starting_date)} %>
      <%= f.input :payday_limit, required: false, label: I18n.t("ag2_gest.bills.index.payday_limit"), :label_html => { :class => 'form-label' }, :input_html => {class: "mid-text-field date_picker", value: @bills.first.pre_invoices.first.try(:billing_period).try(:billing_ending_date)} %>
    </div>
    <div class="modal-footer">
      <%= f.button :submit, "Confirmar facturas", :class => 'btn btn-primary' %>
      <button class="btn" data-dismiss="modal" aria-hidden="true">Cerrar</button>
    </div>
  <% end %>
</div>