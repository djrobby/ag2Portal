<script type="text/javascript">
  $(document).ready(function(){

    $('select.sel2').select2({
      formatNoMatches: function(m) { return '<%= I18n.t("select2.no_matches") %>'; },
      allowClear: true
    });

  });

  jQuery(function($) {

    $("#form_add_meter").bind("ajax:success", function(xhr, data, status) {

      //Clean fields to update after of to insert
      $('#info_meter, #info_brand, #info_caliber').empty();

      //Update fields
      $('#info_meter').prepend(`<a href="/es/ag2_gest/es/meters/${data.meter.id}">${data.meter.meter_code}</a>`);
      $('#info_brand').prepend(`<a href="/es/ag2_gest/es/meter_models/${data.meter_model.id}">${data.meter_model.brand}/${data.meter_model.model}</a>`);
      $('#info_caliber').prepend(`<a href="/es/ag2_gest/es/calibers/${data.caliber.id}">${data.caliber.caliber}</a>`);

      //Close Modal
      $(".modalMeter").modal().hide();
      $('.modalMeter').modal('toggle');

      //Display buttons
      var add_buttons = `<a href='#newReadingModal' id='link_reading' role='button' class='btn btn-mini btn-primary' data-toggle='modal'><%= t('activerecord.attributes.subscriber.reading_new') %></a> <a href='#quitMeter' id='quit_meter' role='button' class='btn btn-mini btn-primary' data-toggle='modal'><%= t('activerecord.attributes.subscriber.remove_meter') %></a> <a href='#changeMeter' id='change_meter' role='button' class='btn btn-mini btn-primary' data-toggle='modal'><%= t('activerecord.attributes.subscriber.change_meter') %></a>`;

      $('#add_meter').after(add_buttons);
      $('#add_meter').remove();

      //Formatt Date
      var date =``;

      if (data.reading.reading_date !== undefined) {
        date += `${data.reading.reading_date.substring(8, 10)}/${data.reading.reading_date.substring(5, 7)}/${data.reading.reading_date.substring(0, 4)}`;
      }

      //Show ReadingIncidenceType
      var reading_incidence_types = "";
      var title = "";

      if (data.reading_incidence_types[0] == undefined && data.reading_incidence_types[0] == null){
        reading_incidence_types = "-";

      } else {
        var str_incidence = data.reading_incidence_types.length;
        /*Añadir los elementos i en función de los incidence types que tenga*/
        for(var i=0; i < str_incidence; i++) {
          if (i >= 1) {
            title += `, `;
          }
          title += `${data.reading_incidence_types[i]}`;
        }
        reading_incidence_types = `<i title="${title}" class="icon-ok"></i>`;
      }

      //Add Reading to Table
      var text = `<tr><td>${data.reading.id}</td><td>-</td><td><a href="/es/ag2_gest/es/reading_types/${data.reading.reading_type_id}">${data.reading_type_name}</a></td><td>${date}</td><td>${data.reading.reading_index}</td><td>${reading_incidence_types}</td>`;
        text += `<td class="a_inline"><a href="/es/ag2_gest/es/readings/${data.reading.id}/edit" class="btn btn-mini"><i class="icon-edit"></i></a><a href="/es/ag2_gest/es/readings/${data.reading.id}"class="btn btn-mini" data-confirm="Are you sure?" data-method="delete" rel="nofollow"><i class="icon-trash"></i></a></td></tr>`;

      $('#readings table tbody').after(text);

      //Put Values to 0
      $('#form_add_meter').find('[type=checkbox]').prop('checked', false);
      $('#sel2_association').select2("val", "");
      $('#input_add_reading_index, #input_add_reading_date, #input_add_meter').val("");

      //Hide Collapse Options //=> doesn't work
      //$('#collapseAddMeter').collapse('hide');

    });

  });//End jQuery function, exclusive $ jQuery function

</script>

<!-- AddMeter -->
<div id="addMeter" class="modal modalMeter hide fade">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3><%= t('activerecord.attributes.subscriber.data_add_meter') %></h3>
  </div>
  <%= simple_form_for @reading, url: { action: :add_meter, controller: 'subscribers'},  :method => :post, :html => { :class => 'form-inline', :id => 'form_add_meter' } do |f| %>
    <div class="modal-body">
      <h4><%= t('activerecord.attributes.contracting_request.data_meter') %></h4>

      <%= f.association :project, collection: @project_dropdown, label: t('activerecord.attributes.subscriber.project'), input_html: { class: 'x-large-text-field sel2', :id => "project" }, :required => true, label_html: { class: 'form-label' }, include_blank: true %>

      <%= f.input :meter, required: true, input_html: { class: 'mid-text-field', id: 'input_add_meter' }, label_html: { class: 'form-label' }, label: t('activerecord.attributes.contracting_request.meter') %>
      <%#= f.association :meter, required: true, collection: Meter.from_office(session[:office]).availables, input_html: { class: 'x-large-text-field sel2', id: 'sel2_association' }, label_html: { class: 'form-label' }, include_blank: true, label: t('activerecord.attributes.contracting_request.meter') %>

      <%= f.input :meter_location_id, required: true, collection: MeterLocation.all, input_html: { class: 'x-large-text-field sel2' }, label_html: { class: 'form-label' }, include_blank: true, label: t('activerecord.attributes.meter_detail.meter_location') %>

      <%= f.input :reading_index, label: t('activerecord.attributes.reading.reading'), :required => true, :autofocus => true, :input_html => { :class => 'x-large-text-field', id: 'input_add_reading_index' }, :label_html => { :class => 'form-label' } %>

      <%= f.input :reading_date, :as => :hidden, :required => true, :start_year => Time.now.year - 100, :end_year => Time.now.year + 100, :as => :string, :input_html => { :value => (f.object.reading_date.strftime("%d/%m/%Y") if f.object.reading_date), :class => 'mid-text-field date_picker', id: 'input_add_reading_date' }, :label_html => { :class => 'form-label' } %>

      <%= f.association :billing_period, collection: BillingPeriod.all, label: t('activerecord.attributes.subscriber.billing_period'), :required => true, input_html: { class: 'x-large-text-field sel2', :id => "billing_period" }, label_html: { class: 'form-label' }, include_blank: true %>

      <div class="accordion-group">
        <div class="accordion-heading">
          <a class="accordion-toggle" data-toggle="collapse" href="#collapseAddMeter"><%= t('activerecord.attributes.subscriber.incidences') %></a>
        </div>
        <div id="collapseAddMeter" class="accordion-body collapse">
          <div class="accordion-inner">
            <ul class="unstyled">
              <% ReadingIncidenceType.all.each do |incidence_type| %>
                <li style="width:50%;float:left;">
                  <label class="checkbox">
                    <%= check_box_tag 'incidence_type_ids[]', incidence_type.id %>
                    <%= h incidence_type.name %>
                  </label>
                </li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>

    </div>
    <div class="modal-footer">
      <%= f.submit t('activerecord.attributes.subscriber.accept'), :class => "btn btn-primary", :id => "btn_submit" %>
      <button class="btn btn-primary" data-dismiss="modal"><%= t('activerecord.attributes.subscriber.close') %></button>
    </div>
  <% end %>
</div>
